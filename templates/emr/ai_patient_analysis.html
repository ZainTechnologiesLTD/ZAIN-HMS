<!-- templates/emr/ai_patient_analysis.html -->
{% extends 'base/base_dashboard.html' %}
{% load static %}

{% block title %}AI Patient Analysis - {{ patient.get_full_name }}{% endblock %}

{% block extra_css %}

    <link rel="stylesheet" href="{% static 'css/emr/ai_patient_analysis.css' %}">
{% endblock %}

{% block content %}
<div class="ai-patient-analysis">
    <!-- Patient Header -->
    <div class="patient-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-user-md text-primary me-3"></i>
                    AI Patient Analysis
                </h1>
                <h3 class="text-muted mb-2">{{ patient.get_full_name }}</h3>
                <div class="patient-info">
                    <span class="badge bg-info me-2">{{ patient.age }} years old</span>
                    <span class="badge bg-secondary me-2">{{ patient.get_gender_display }}</span>
                    <span class="badge bg-primary">ID: {{ patient.patient_id }}</span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                {% if ai_analysis.overall_risk %}
                <div class="risk-indicator risk-{{ ai_analysis.overall_risk.risk_level|lower }}">
                    {{ ai_analysis.overall_risk.risk_level }} Risk Patient
                </div>
                <div class="mt-2">
                    <small class="text-muted">Risk Score: {{ ai_analysis.overall_risk.risk_score }}/100</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Analysis Column -->
        <div class="col-lg-8">
            <!-- AI Overall Assessment -->
            {% if ai_analysis.overall_risk %}
            <div class="analysis-card {% if ai_analysis.overall_risk.risk_level == 'HIGH' %}critical{% elif ai_analysis.overall_risk.risk_level == 'MEDIUM' %}warning{% else %}success{% endif %}">
                <h5 class="section-title">
                    <i class="fas fa-brain"></i>
                    AI Overall Assessment
                </h5>

                <div class="ai-insight">
                    <h6><i class="fas fa-lightbulb me-2"></i>Clinical Summary</h6>
                    <p class="mb-2">
                        Patient presents with {{ ai_analysis.overall_risk.risk_level|lower }} clinical risk based on comprehensive AI analysis.
                        {% if ai_analysis.overall_risk.risk_factors %}
                        Key risk factors identified include active clinical concerns requiring attention.
                        {% endif %}
                    </p>
                </div>

                {% if ai_analysis.overall_risk.risk_factors %}
                <div class="mt-3">
                    <h6>Identified Risk Factors:</h6>
                    <ul class="list-unstyled">
                        {% for factor in ai_analysis.overall_risk.risk_factors %}
                        <li class="mb-2">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            {{ factor }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Symptom Analysis -->
            {% if ai_analysis.symptom_analysis %}
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-stethoscope"></i>
                    AI Symptom Analysis
                </h5>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Analyzed Symptoms:</h6>
                        <div class="symptoms-container">
                            {% for symptom in ai_analysis.symptom_analysis.symptoms %}
                            <span class="symptom-tag">{{ symptom|title }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Top Differential Diagnoses:</h6>
                        {% for diagnosis in ai_analysis.symptom_analysis.possible_conditions %}
                        <div class="recommendation-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{ diagnosis.condition|title }}</strong>
                                <span class="badge bg-info">{{ diagnosis.probability }}%</span>
                            </div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: {{ diagnosis.probability }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {% if ai_analysis.symptom_analysis.recommendations %}
                <div class="ai-insight mt-3">
                    <h6><i class="fas fa-clipboard-check me-2"></i>AI Recommendations</h6>
                    <ul class="mb-0">
                        {% for rec in ai_analysis.symptom_analysis.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Vital Signs Analysis -->
            {% if ai_analysis.vital_analysis %}
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-heartbeat"></i>
                    AI Vital Signs Analysis
                </h5>

                <div class="row">
                    {% for vital, analysis in ai_analysis.vital_analysis.vital_assessments.items %}
                    <div class="col-md-6 mb-3">
                        <div class="vital-reading {% if analysis.status != 'NORMAL' %}abnormal{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>{{ vital|title|replace:"_":" " }}</strong>
                                <span class="badge bg-{% if analysis.status == 'NORMAL' %}success{% elif analysis.status == 'ABNORMAL' %}warning{% else %}danger{% endif %}">
                                    {{ analysis.status }}
                                </span>
                            </div>
                            <div class="mt-1">
                                <span class="text-muted">Value: {{ analysis.value }} {{ analysis.unit|default:"" }}</span>
                                {% if analysis.reference_range %}
                                <small class="d-block text-muted">Normal: {{ analysis.reference_range }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if ai_analysis.vital_analysis.alerts %}
                <div class="mt-3">
                    <h6>AI Alerts:</h6>
                    {% for alert in ai_analysis.vital_analysis.alerts %}
                    <div class="alert alert-{% if alert.severity == 'HIGH' %}danger{% elif alert.severity == 'MEDIUM' %}warning{% else %}info{% endif %}">
                        <strong>{{ alert.vital|title }}</strong>: {{ alert.message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Lab Results Analysis -->
            {% if ai_analysis.lab_analysis %}
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-vial"></i>
                    AI Laboratory Analysis
                </h5>

                <div class="row">
                    {% for test, result in ai_analysis.lab_analysis.test_results.items %}
                    <div class="col-md-6 mb-2">
                        <div class="lab-result {% if result.status != 'NORMAL' %}abnormal{% else %}normal{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ test|title|replace:"_":" " }}</strong>
                                    <div class="text-muted small">{{ result.value }} {{ result.unit|default:"" }}</div>
                                </div>
                                <span class="badge bg-{% if result.status == 'NORMAL' %}success{% elif result.status == 'ABNORMAL' %}warning{% else %}danger{% endif %}">
                                    {{ result.status }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if ai_analysis.lab_analysis.abnormal_results %}
                <div class="mt-3">
                    <h6>Abnormal Findings:</h6>
                    {% for finding in ai_analysis.lab_analysis.abnormal_results %}
                    <div class="alert alert-{% if finding.severity == 'HIGH' %}danger{% elif finding.severity == 'MEDIUM' %}warning{% else %}info{% endif %}">
                        <strong>{{ finding.test|title }}</strong>: {{ finding.interpretation }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if ai_analysis.lab_analysis.clinical_significance %}
                <div class="ai-insight">
                    <h6><i class="fas fa-microscope me-2"></i>Clinical Significance</h6>
                    <p class="mb-0">{{ ai_analysis.lab_analysis.clinical_significance }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Medication Analysis -->
            {% if ai_analysis.medication_analysis %}
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-pills"></i>
                    AI Medication Analysis
                </h5>

                <div class="row">
                    <div class="col-md-8">
                        <h6>Current Medications:</h6>
                        {% for med in current_medications %}
                        <div class="medication-item {% if med.has_interactions %}interaction{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ med.medication_name }}</strong>
                                    <div class="text-muted small">
                                        {{ med.dosage }} • {{ med.frequency }} • {{ med.route }}
                                    </div>
                                </div>
                                <span class="badge bg-{% if med.status == 'ACTIVE' %}success{% else %}secondary{% endif %}">
                                    {{ med.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <h6>Risk Assessment:</h6>
                        <div class="text-center">
                            <div class="risk-indicator risk-{{ ai_analysis.medication_analysis.risk_level|lower }}">
                                {{ ai_analysis.medication_analysis.risk_level }} Risk
                            </div>
                        </div>
                    </div>
                </div>

                {% if ai_analysis.medication_analysis.interactions %}
                <div class="mt-3">
                    <h6>Drug Interactions Detected:</h6>
                    {% for interaction in ai_analysis.medication_analysis.interactions %}
                    <div class="alert alert-{% if interaction.severity == 'MAJOR' %}danger{% elif interaction.severity == 'MODERATE' %}warning{% else %}info{% endif %}">
                        <strong>{{ interaction.drug1 }} ↔ {{ interaction.drug2 }}</strong><br>
                        <small>{{ interaction.description }}</small>
                        <div class="mt-1">
                            <span class="badge bg-{{ interaction.severity|lower }}">{{ interaction.severity }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if ai_analysis.medication_analysis.recommendations %}
                <div class="ai-insight">
                    <h6><i class="fas fa-prescription-bottle-alt me-2"></i>Medication Recommendations</h6>
                    <ul class="mb-0">
                        {% for rec in ai_analysis.medication_analysis.recommendations %}
                        <li>{{ rec }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Active Alerts -->
            {% if active_alerts %}
            <div class="analysis-card critical">
                <h5 class="section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Active Alerts
                </h5>

                {% for alert in active_alerts %}
                <div class="alert alert-{% if alert.severity == 'CRITICAL' %}danger{% elif alert.severity == 'HIGH' %}warning{% else %}info{% endif %} alert-dismissible">
                    <h6 class="alert-heading">{{ alert.title }}</h6>
                    <p class="mb-1">{{ alert.description|truncatechars:100 }}</p>
                    <small class="text-muted">{{ alert.created_at|timesince }} ago</small>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-success" onclick="acknowledgeAlert({{ alert.id }})">
                            Acknowledge
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- AI Recommendations -->
            {% if recommendations %}
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-lightbulb"></i>
                    AI Recommendations
                </h5>

                {% for rec in recommendations %}
                <div class="recommendation-item">
                    <h6>{{ rec.get_recommendation_type_display }}</h6>
                    <p class="small text-muted">{{ rec.recommendation_text|truncatechars:120 }}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-info">{{ rec.confidence_score }}% confident</span>
                        <button class="btn btn-sm btn-primary" onclick="viewRecommendationDetails({{ rec.id }})">
                            Details
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Recent Medical Records -->
            {% if recent_records %}
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-file-medical"></i>
                    Recent Records
                </h5>

                {% for record in recent_records %}
                <div class="mb-3 p-2 border-start border-3 border-info">
                    <h6 class="mb-1">{{ record.record_date|date:"M d, Y" }}</h6>
                    <p class="small text-muted mb-1">
                        <strong>Chief Complaint:</strong> {{ record.chief_complaint|truncatechars:60 }}
                    </p>
                    {% if record.ai_diagnostic_suggestions %}
                    <div class="ai-suggestions">
                        <small class="text-primary">
                            <i class="fas fa-robot me-1"></i>AI Suggestions: {{ record.ai_diagnostic_suggestions|truncatechars:50 }}
                        </small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="analysis-card">
                <h5 class="section-title">
                    <i class="fas fa-bolt"></i>
                    Quick Actions
                </h5>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="generateTreatmentPlan()">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Generate Treatment Plan
                    </button>
                    <button class="btn btn-info" onclick="checkMedicationInteractions()">
                        <i class="fas fa-pills me-2"></i>
                        Check Drug Interactions
                    </button>
                    <button class="btn btn-success" onclick="scheduleFollowUp()">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Schedule Follow-up
                    </button>
                    <button class="btn btn-secondary" onclick="exportAnalysis()">
                        <i class="fas fa-download me-2"></i>
                        Export Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendation Details Modal -->
<div class="modal fade" id="recommendationDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Recommendation Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="recommendationDetailsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="implementRecommendationBtn">
                    Implement Recommendation
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

    <script src="{% static 'js/emr/ai_patient_analysis.js' %}"></script>
{% endblock %}
