{% extends 'base/base_print.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Bill" %} #{{ bill.invoice_number }}{% endblock %}

{% block print_content %}
<div class="print-document">
    <!-- Hospital Header -->
    <div class="hospital-header">
        <div class="row align-items-center">
            <div class="col-8">
                <h1 class="hospital-name">{{ bill.hospital.name }}</h1>
                <div class="hospital-details">
                    <p><i class="fas fa-map-marker-alt"></i> {{ bill.hospital.address }}</p>
                    <p><i class="fas fa-phone"></i> {{ bill.hospital.phone|default:"N/A" }}</p>
                    <p><i class="fas fa-envelope"></i> {{ bill.hospital.email|default:"N/A" }}</p>
                </div>
            </div>
            <div class="col-4 text-end">
                <!-- Barcode Component -->
                {% include 'components/barcode.html' with object=bill %}
            </div>
        </div>
    </div>

    <!-- Document Header -->
    <div class="document-header">
        <div class="row">
            <div class="col-6">
                <h2 class="document-title">{% trans "MEDICAL BILL" %}</h2>
            </div>
            <div class="col-6 text-end">
                <!-- Serial Number Component -->
                {% include 'components/serial_display.html' with object=bill %}
            </div>
        </div>
    </div>

    <!-- Bill Information -->
    <div class="bill-info-section">
        <div class="row">
            <div class="col-6">
                <div class="info-box">
                    <h5>{% trans "Bill Information" %}</h5>
                    <table class="info-table">
                        <tr>
                            <td><strong>{% trans "Bill Number" %}:</strong></td>
                            <td>{{ bill.invoice_number }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Serial Number" %}:</strong></td>
                            <td>{{ bill.serial_number }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Bill Date" %}:</strong></td>
                            <td>{{ bill.invoice_date|date:"F d, Y" }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Due Date" %}:</strong></td>
                            <td>{{ bill.due_date|date:"F d, Y" }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Payment Terms" %}:</strong></td>
                            <td>{{ bill.get_payment_terms_display }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Status" %}:</strong></td>
                            <td><span class="status-badge status-{{ bill.status|lower }}">{{ bill.get_status_display }}</span></td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="col-6">
                <div class="info-box">
                    <h5>{% trans "Patient Information" %}</h5>
                    <table class="info-table">
                        <tr>
                            <td><strong>{% trans "Patient Name" %}:</strong></td>
                            <td>{{ bill.patient.user.get_full_name }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Patient ID" %}:</strong></td>
                            <td>{{ bill.patient.patient_id }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Phone" %}:</strong></td>
                            <td>{{ bill.patient.phone|default:"N/A" }}</td>
                        </tr>
                        <tr>
                            <td><strong>{% trans "Email" %}:</strong></td>
                            <td>{{ bill.patient.user.email|default:"N/A" }}</td>
                        </tr>
                        {% if bill.patient.address %}
                        <tr>
                            <td><strong>{% trans "Address" %}:</strong></td>
                            <td>{{ bill.patient.address }}</td>
                        </tr>
                        {% endif %}
                        {% if bill.appointment %}
                        <tr>
                            <td><strong>{% trans "Appointment" %}:</strong></td>
                            <td>{{ bill.appointment.appointment_date|date:"M d, Y" }} - {{ bill.appointment.doctor.user.get_full_name }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Items -->
    <div class="bill-items-section">
        <h5>{% trans "Bill Items" %}</h5>
        <table class="bill-items-table">
            <thead>
                <tr>
                    <th>{% trans "Service Code" %}</th>
                    <th>{% trans "Description" %}</th>
                    <th class="text-center">{% trans "Quantity" %}</th>
                    <th class="text-end">{% trans "Unit Price" %}</th>
                    <th class="text-end">{% trans "Amount" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for item in bill.items.all %}
                <tr>
                    <td>{{ item.service.code|default:"N/A" }}</td>
                    <td>{{ item.service.name|default:item.description }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-end">${{ item.unit_price|floatformat:2 }}</td>
                    <td class="text-end">${{ item.total_amount|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">{% trans "No items found" %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Bill Summary -->
    <div class="bill-summary-section">
        <div class="row">
            <div class="col-6">
                {% if bill.notes %}
                <div class="notes-section">
                    <h6>{% trans "Notes" %}</h6>
                    <p>{{ bill.notes|linebreaks }}</p>
                </div>
                {% endif %}
            </div>
            <div class="col-6">
                <div class="summary-box">
                    <table class="summary-table">
                        <tr>
                            <td><strong>{% trans "Subtotal" %}:</strong></td>
                            <td class="text-end">${{ bill.subtotal|floatformat:2 }}</td>
                        </tr>
                        {% if bill.discount_amount > 0 %}
                        <tr>
                            <td><strong>{% trans "Discount" %} ({{ bill.discount_percentage }}%):</strong></td>
                            <td class="text-end">-${{ bill.discount_amount|floatformat:2 }}</td>
                        </tr>
                        {% endif %}
                        {% if bill.tax_amount > 0 %}
                        <tr>
                            <td><strong>{% trans "Tax" %} ({{ bill.tax_rate }}%):</strong></td>
                            <td class="text-end">${{ bill.tax_amount|floatformat:2 }}</td>
                        </tr>
                        {% endif %}
                        <tr class="total-row">
                            <td><strong>{% trans "Total Amount" %}:</strong></td>
                            <td class="text-end"><strong>${{ bill.total_amount|floatformat:2 }}</strong></td>
                        </tr>
                        {% if bill.paid_amount > 0 %}
                        <tr>
                            <td><strong>{% trans "Paid Amount" %}:</strong></td>
                            <td class="text-end">${{ bill.paid_amount|floatformat:2 }}</td>
                        </tr>
                        <tr class="balance-row">
                            <td><strong>{% trans "Balance Due" %}:</strong></td>
                            <td class="text-end"><strong>${{ bill.balance_amount|floatformat:2 }}</strong></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment History -->
    {% if bill.payments.exists %}
    <div class="payment-history-section">
        <h5>{% trans "Payment History" %}</h5>
        <table class="payment-history-table">
            <thead>
                <tr>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Method" %}</th>
                    <th>{% trans "Reference" %}</th>
                    <th>{% trans "Notes" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in bill.payments.all %}
                <tr>
                    <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                    <td>${{ payment.amount|floatformat:2 }}</td>
                    <td>{{ payment.get_payment_method_display }}</td>
                    <td>{{ payment.reference_number|default:"N/A" }}</td>
                    <td>{{ payment.notes|default:"N/A" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="print-footer">
        <div class="row">
            <div class="col-6">
                <small class="text-muted">
                    {% trans "Generated on" %} {{ "now"|date:"F d, Y g:i A" }}<br>
                    {% trans "Serial Number" %}: {{ bill.serial_number }}
                </small>
            </div>
            <div class="col-6 text-end">
                <small class="text-muted">
                    {% trans "Scan QR code for quick access" %}<br>
                    {{ bill.hospital.name }}
                </small>
            </div>
        </div>
    </div>
</div>


{% endblock %}
