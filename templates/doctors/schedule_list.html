{% extends 'base/base_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Doctor Schedules" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'css/doctors/schedule_list.css' %}">

{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="bi bi-calendar-week me-2 text-primary"></i>{% trans "Doctor Schedules Management" %}
                    </h1>
                    <p class="text-muted mt-1">{% trans "Manage doctor working hours and availability by department" %}</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'doctors:doctor_create' %}" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i>{% trans "Add Doctor" %}
                    </a>
                    <a href="{% url 'doctors:doctor_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i>{% trans "Back to Doctors" %}
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-people fs-1"></i>
                        </div>
                        <div>
                            <div class="fs-4 fw-bold">{{ total_doctors }}</div>
                            <div class="small opacity-75">{% trans "Total Doctors" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card success h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-calendar-check fs-1"></i>
                        </div>
                        <div>
                            <div class="fs-4 fw-bold">{{ scheduled_doctors }}</div>
                            <div class="small opacity-75">{% trans "With Schedule" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card warning h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-calendar-x fs-1"></i>
                        </div>
                        <div>
                            <div class="fs-4 fw-bold">{{ unscheduled_doctors }}</div>
                            <div class="small opacity-75">{% trans "Need Schedule" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card info h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-collection fs-1"></i>
                        </div>
                        <div>
                            <div class="fs-4 fw-bold">{{ departments|length }}</div>
                            <div class="small opacity-75">{% trans "Departments" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-card">
                <form method="get" id="filterForm" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="search" class="form-label fw-semibold">
                            <i class="bi bi-search me-1"></i>{% trans "Search Doctors" %}
                        </label>
                        <input type="text"
                               id="search"
                               name="search"
                               class="form-control search-input"
                               placeholder="{% trans 'Search by name, specialization, or license...' %}"
                               value="{{ current_search }}">
                    </div>
                    <div class="col-md-3">
                        <label for="department" class="form-label fw-semibold">
                            <i class="bi bi-funnel me-1"></i>{% trans "Department" %}
                        </label>
                        <select name="department" id="department" class="form-select filter-select">
                            <option value="">{% trans "All Departments" %}</option>
                            {% for dept_code, dept_name in departments %}
                                <option value="{{ dept_code }}" {% if current_department == dept_code %}selected{% endif %}>
                                    {{ dept_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="schedule_status" class="form-label fw-semibold">
                            <i class="bi bi-calendar-event me-1"></i>{% trans "Schedule Status" %}
                        </label>
                        <select name="schedule_status" id="schedule_status" class="form-select filter-select">
                            <option value="">{% trans "All Doctors" %}</option>
                            <option value="with_schedule" {% if current_schedule_status == 'with_schedule' %}selected{% endif %}>
                                {% trans "With Schedule" %}
                            </option>
                            <option value="no_schedule" {% if current_schedule_status == 'no_schedule' %}selected{% endif %}>
                                {% trans "Need Schedule" %}
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="bi bi-funnel-fill me-1"></i>{% trans "Filter" %}
                            </button>
                            <a href="{% url 'doctors:schedule_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-clockwise"></i>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Doctor Cards -->
    <div class="row mb-4" id="doctorCards">
        {% for doctor in doctors %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4">
            <div class="card schedule-card position-relative {% if doctor.schedule_count > 0 %}has-schedule{% else %}no-schedule{% endif %}">
                <div class="schedule-status">
                    {% if doctor.schedule_count > 0 %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle me-1"></i>{{ doctor.schedule_count }} schedule{{ doctor.schedule_count|pluralize }}
                        </span>
                    {% else %}
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-exclamation-triangle me-1"></i>{% trans "No schedule" %}
                        </span>
                    {% endif %}
                </div>

                <div class="card-body text-center p-4">
                    <div class="doctor-avatar mx-auto mb-3">
                        {{ doctor.first_name|first|upper }}{{ doctor.last_name|first|upper }}
                    </div>

                    <h6 class="card-title mb-2 fw-bold">
                        Dr. {{ doctor.first_name }} {{ doctor.last_name }}
                    </h6>

                    <div class="mb-3">
                        <span class="badge bg-primary department-badge">
                            {{ doctor.get_specialization_display }}
                        </span>
                    </div>

                    <div class="mb-3 text-muted small">
                        <div class="d-flex align-items-center justify-content-center mb-1">
                            <i class="bi bi-card-text me-2"></i>
                            <span>{{ doctor.license_number }}</span>
                        </div>
                        {% if doctor.phone %}
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-telephone me-2"></i>
                            <span>{{ doctor.phone }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="d-grid">
                        <a href="{% url 'doctors:schedule_manage' doctor.id %}"
                           class="btn {% if doctor.schedule_count > 0 %}btn-primary{% else %}btn-warning{% endif %}">
                            {% if doctor.schedule_count > 0 %}
                                <i class="bi bi-pencil-square me-1"></i>{% trans "Edit Schedule" %}
                            {% else %}
                                <i class="bi bi-calendar-plus me-1"></i>{% trans "Create Schedule" %}
                            {% endif %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="no-results">
                <i class="bi bi-search text-muted mb-3" style="font-size: 3rem;"></i>
                <h5 class="text-muted">{% trans "No doctors found" %}</h5>
                {% if current_search or current_department or current_schedule_status %}
                    <p class="text-muted mb-3">{% trans "Try adjusting your search criteria" %}</p>
                    <a href="{% url 'doctors:schedule_list' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-clockwise me-1"></i>{% trans "Clear Filters" %}
                    </a>
                {% else %}
                    <p class="text-muted mb-3">{% trans "Add doctors first to manage their schedules" %}</p>
                    <a href="{% url 'doctors:doctor_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-1"></i>{% trans "Add Doctor" %}
                    </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="Doctor pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_department %}&department={{ current_department }}{% endif %}{% if current_schedule_status %}&schedule_status={{ current_schedule_status }}{% endif %}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_department %}&department={{ current_department }}{% endif %}{% if current_schedule_status %}&schedule_status={{ current_schedule_status }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}{% if current_department %}&department={{ current_department }}{% endif %}{% if current_schedule_status %}&schedule_status={{ current_schedule_status }}{% endif %}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}

    <!-- Recent Schedule Updates -->
    {% if recent_schedules %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 bg-light">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="bi bi-clock-history me-2"></i>{% trans "Recent Schedule Updates" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>{% trans "Doctor" %}</th>
                                    <th>{% trans "Department" %}</th>
                                    <th>{% trans "Day" %}</th>
                                    <th>{% trans "Time" %}</th>
                                    <th>{% trans "Actions" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in recent_schedules %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="doctor-avatar me-3" style="width: 35px; height: 35px; font-size: 0.8rem;">
                                                {{ schedule.doctor.first_name|first|upper }}{{ schedule.doctor.last_name|first|upper }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">Dr. {{ schedule.doctor.first_name }} {{ schedule.doctor.last_name }}</div>
                                                <small class="text-muted">{{ schedule.doctor.license_number }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary department-badge">
                                            {{ schedule.doctor.get_specialization_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            {{ schedule.get_day_of_week_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-clock me-2 text-muted"></i>
                                            <span class="schedule-count">{{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{% url 'doctors:schedule_manage' schedule.doctor.id %}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil me-1"></i>{% trans "Edit" %}
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Overlay Template -->
<div id="loadingOverlay" class="loading-overlay d-none">
    <div class="text-center">
        <div class="spinner-border text-primary mb-2" role="status">
            <span class="visually-hidden">{% trans "Loading..." %}</span>
        </div>
        <div class="text-muted">{% trans "Filtering doctors..." %}</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

    <script src="{% static 'js/doctors/schedule_list.js' %}"></script>
{% endblock %}
