{% extends 'base_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Barcode Scanner" %} - ZAIN HMS{% endblock %}

{% block extra_css %}
<style>
    .scanner-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .scanner-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
    }
    
    .scanner-methods {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .scanner-method {
        padding: 25px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .scanner-method:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    }
    
    .scanner-method.active {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    
    .scanner-method i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #007bff;
    }
    
    .barcode-input-section {
        display: none;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .barcode-input-section.active {
        display: block;
    }
    
    .barcode-input {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 15px;
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
    }
    
    .barcode-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    .camera-section {
        display: none;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .camera-section.active {
        display: block;
    }
    
    .camera-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    #camera-feed {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }
    
    .camera-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 3px solid #00ff00;
        width: 250px;
        height: 100px;
        border-radius: 8px;
        opacity: 0.8;
    }
    
    .camera-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .search-results {
        display: none;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .search-results.active {
        display: block;
    }
    
    .results-header {
        padding: 20px;
        background: #007bff;
        color: white;
    }
    
    .results-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .result-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .result-item:hover {
        background-color: #f8f9fa;
    }
    
    .result-item:last-child {
        border-bottom: none;
    }
    
    .result-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .result-subtitle {
        color: #6c757d;
        font-size: 14px;
    }
    
    .result-type {
        display: inline-block;
        padding: 2px 8px;
        background: #e9ecef;
        color: #495057;
        border-radius: 12px;
        font-size: 11px;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .manual-search-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
        color: #007bff;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .error-message {
        display: none;
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .error-message.active {
        display: block;
    }
    
    .success-message {
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .success-message.active {
        display: block;
    }
    
    @media (max-width: 768px) {
        .scanner-methods {
            grid-template-columns: 1fr;
        }
        
        .camera-controls {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="scanner-container">
    <!-- Scanner Header -->
    <div class="scanner-header">
        <h1><i class="fas fa-barcode me-3"></i>{% trans "Hospital Barcode Scanner" %}</h1>
        <p class="mb-0">{% trans "Scan barcodes on hospital documents or enter barcode manually" %}</p>
    </div>
    
    <!-- Scanner Method Selection -->
    <div class="scanner-methods">
        <div class="scanner-method" onclick="selectScannerMethod('barcode')" id="barcode-method">
            <i class="fas fa-barcode"></i>
            <h5>{% trans "Barcode Input" %}</h5>
            <p class="text-muted mb-0">{% trans "Type or scan barcode directly" %}</p>
        </div>
        <div class="scanner-method" onclick="selectScannerMethod('camera')" id="camera-method">
            <i class="fas fa-camera"></i>
            <h5>{% trans "Camera Scanner" %}</h5>
            <p class="text-muted mb-0">{% trans "Use camera to scan barcodes" %}</p>
        </div>
    </div>
    
    <!-- Barcode Input Section -->
    <div class="barcode-input-section" id="barcode-input-section">
        <h4><i class="fas fa-barcode me-2"></i>{% trans "Enter Barcode" %}</h4>
        <p class="text-muted">{% trans "Type the barcode number or scan directly with a barcode scanner" %}</p>
        
        <input type="text" 
               id="barcode-input" 
               class="barcode-input" 
               placeholder="{% trans 'Enter barcode here...' %}"
               autofocus>
        
        <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="searchBarcode()">
                <i class="fas fa-search me-2"></i>{% trans "Search" %}
            </button>
            <button class="btn btn-outline-secondary" onclick="clearInput()">
                <i class="fas fa-times me-2"></i>{% trans "Clear" %}
            </button>
        </div>
        
        <div class="manual-search-section">
            <h6>{% trans "Manual Search" %}</h6>
            <p class="text-muted small">{% trans "Can't find what you're looking for? Try manual search:" %}</p>
            <div class="d-flex gap-2 flex-wrap">
                <input type="text" id="manual-search" class="form-control" placeholder="{% trans 'Search by name, ID, phone...' %}">
                <button class="btn btn-outline-info" onclick="manualSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Camera Section -->
    <div class="camera-section" id="camera-section">
        <h4><i class="fas fa-camera me-2"></i>{% trans "Camera Barcode Scanner" %}</h4>
        <p class="text-muted">{% trans "Position the barcode within the green frame" %}</p>
        
        <div class="camera-container">
            <video id="camera-feed" autoplay playsinline></video>
            <div class="camera-overlay"></div>
        </div>
        
        <div class="camera-controls">
            <button class="btn btn-success" onclick="startCamera()" id="start-camera">
                <i class="fas fa-play me-2"></i>{% trans "Start Camera" %}
            </button>
            <button class="btn btn-danger" onclick="stopCamera()" id="stop-camera" style="display: none;">
                <i class="fas fa-stop me-2"></i>{% trans "Stop Camera" %}
            </button>
            <button class="btn btn-warning" onclick="toggleFlash()" id="toggle-flash" style="display: none;">
                <i class="fas fa-lightbulb me-2"></i>{% trans "Flash" %}
            </button>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{% trans "Loading..." %}</span>
        </div>
        <p class="mt-3">{% trans "Searching hospital records..." %}</p>
    </div>
    
    <!-- Search Results -->
    <div class="search-results" id="search-results">
        <div class="results-header">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>{% trans "Search Results" %}</h5>
        </div>
        <div class="results-list" id="results-list">
            <!-- Results will be populated here -->
        </div>
    </div>
    
    <!-- Messages -->
    <div class="error-message" id="error-message"></div>
    <div class="success-message" id="success-message"></div>
</div>

<script>
let currentStream = null;
let flashSupported = false;

// Initialize barcode input as default
document.addEventListener('DOMContentLoaded', function() {
    selectScannerMethod('barcode');
    
    // Auto-search when barcode is entered
    document.getElementById('barcode-input').addEventListener('input', function(e) {
        const value = e.target.value.trim();
        if (value.length >= 8) {  // Minimum barcode length
            searchBarcode();
        }
    });
    
    // Manual search on Enter
    document.getElementById('manual-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            manualSearch();
        }
    });
});

function selectScannerMethod(method) {
    // Reset active states
    document.querySelectorAll('.scanner-method').forEach(m => m.classList.remove('active'));
    document.querySelectorAll('.barcode-input-section, .camera-section').forEach(s => s.classList.remove('active'));
    
    // Set active method
    document.getElementById(method + '-method').classList.add('active');
    document.getElementById(method + '-input-section').classList.add('active');
    
    if (method === 'barcode') {
        document.getElementById('barcode-input').focus();
        stopCamera();
    }
}

function searchBarcode() {
    const barcodeValue = document.getElementById('barcode-input').value.trim();
    
    if (!barcodeValue) {
        showError('{% trans "Please enter a barcode" %}');
        return;
    }
    
    showLoading(true);
    hideMessages();
    
    fetch('{% url "core:barcode_search" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'barcode_data': barcodeValue
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success && data.results.length > 0) {
            displayResults(data.results);
            showSuccess(`{% trans "Found" %} ${data.results.length} {% trans "record(s)" %}`);
        } else {
            showError('{% trans "No records found for this barcode" %}');
            hideResults();
        }
    })
    .catch(error => {
        showLoading(false);
        showError('{% trans "Search failed. Please try again." %}');
        console.error('Search error:', error);
    });
}

function manualSearch() {
    const searchQuery = document.getElementById('manual-search').value.trim();
    
    if (!searchQuery) {
        showError('{% trans "Please enter search terms" %}');
        return;
    }
    
    showLoading(true);
    hideMessages();
    
    fetch('{% url "core:manual_search" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'query': searchQuery
        })
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        
        if (data.success && data.results.length > 0) {
            displayResults(data.results);
            showSuccess(`{% trans "Found" %} ${data.results.length} {% trans "record(s)" %}`);
        } else {
            showError('{% trans "No records found" %}');
            hideResults();
        }
    })
    .catch(error => {
        showLoading(false);
        showError('{% trans "Search failed. Please try again." %}');
        console.error('Search error:', error);
    });
}

function displayResults(results) {
    const resultsList = document.getElementById('results-list');
    resultsList.innerHTML = '';
    
    results.forEach(result => {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.onclick = () => window.open(result.url, '_blank');
        
        resultItem.innerHTML = `
            <div class="result-type">${result.type.replace('_', ' ')}</div>
            <div class="result-title">${result.title}</div>
            <div class="result-subtitle">${result.subtitle}</div>
        `;
        
        resultsList.appendChild(resultItem);
    });
    
    document.getElementById('search-results').classList.add('active');
}

function clearInput() {
    document.getElementById('barcode-input').value = '';
    document.getElementById('manual-search').value = '';
    hideResults();
    hideMessages();
    document.getElementById('barcode-input').focus();
}

function hideResults() {
    document.getElementById('search-results').classList.remove('active');
}

function showLoading(show) {
    const spinner = document.getElementById('loading-spinner');
    if (show) {
        spinner.classList.add('active');
    } else {
        spinner.classList.remove('active');
    }
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.classList.add('active');
}

function showSuccess(message) {
    const successDiv = document.getElementById('success-message');
    successDiv.textContent = message;
    successDiv.classList.add('active');
}

function hideMessages() {
    document.getElementById('error-message').classList.remove('active');
    document.getElementById('success-message').classList.remove('active');
}

// Camera functions
async function startCamera() {
    try {
        const constraints = {
            video: {
                facingMode: 'environment', // Use back camera
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('camera-feed');
        video.srcObject = currentStream;
        
        // Check for flash support
        const track = currentStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        flashSupported = 'torch' in capabilities;
        
        document.getElementById('start-camera').style.display = 'none';
        document.getElementById('stop-camera').style.display = 'inline-block';
        
        if (flashSupported) {
            document.getElementById('toggle-flash').style.display = 'inline-block';
        }
        
        showSuccess('{% trans "Camera started successfully" %}');
        
    } catch (error) {
        showError('{% trans "Failed to access camera" %}');
        console.error('Camera error:', error);
    }
}

function stopCamera() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
        
        document.getElementById('start-camera').style.display = 'inline-block';
        document.getElementById('stop-camera').style.display = 'none';
        document.getElementById('toggle-flash').style.display = 'none';
        
        const video = document.getElementById('camera-feed');
        video.srcObject = null;
    }
}

async function toggleFlash() {
    if (currentStream && flashSupported) {
        const track = currentStream.getVideoTracks()[0];
        const constraints = track.getConstraints();
        
        try {
            await track.applyConstraints({
                advanced: [{
                    torch: !constraints.advanced?.[0]?.torch
                }]
            });
        } catch (error) {
            console.error('Flash toggle error:', error);
        }
    }
}
</script>
{% endblock %}
