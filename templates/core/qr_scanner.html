<!-- templates/core/qr_scanner.html -->
{% extends "base_dashboard.html" %}
{% load i18n %}

{% block title %}{% trans "QR Scanner" %}{% endblock %}

{% block extra_css %}
<style>
.scanner-container {
    max-width: 600px;
    margin: 0 auto;
}

.camera-preview {
    border: 3px solid #007bff;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    background: #000;
    min-height: 300px;
}

.camera-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    border: 2px solid #fff;
    border-radius: 10px;
    box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0.3);
}

.search-result {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    background: #fff;
    transition: all 0.2s;
}

.search-result:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.result-type-badge {
    font-size: 0.75em;
    padding: 3px 8px;
    border-radius: 12px;
}

.result-details {
    font-size: 0.85em;
    color: #6c757d;
}

.scanner-status {
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    text-align: center;
}

.scanner-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.scanner-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.scanner-status.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

@media (max-width: 768px) {
    .camera-overlay {
        width: 150px;
        height: 150px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-qrcode me-2"></i>
                        {% trans "QR Code Scanner" %}
                    </h1>
                    <p class="text-muted">{% trans "Scan QR codes to quickly find patient records, appointments, and reports" %}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-camera me-2"></i>
                        {% trans "Camera Scanner" %}
                    </h5>
                </div>
                <div class="card-body scanner-container">
                    <div id="camera-preview" class="camera-preview mb-3">
                        <div class="camera-overlay"></div>
                        <div id="scanner-placeholder" class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center text-white">
                                <i class="fas fa-camera fa-3x mb-3"></i>
                                <p>{% trans "Click 'Start Camera' to begin scanning" %}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="scanner-status" class="scanner-status info">
                        {% trans "Camera not started" %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button id="start-camera" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>
                            {% trans "Start Camera" %}
                        </button>
                        <button id="stop-camera" class="btn btn-secondary" style="display: none;">
                            <i class="fas fa-stop me-2"></i>
                            {% trans "Stop Camera" %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Search -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        {% trans "Manual Search" %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" id="manual-search" class="form-control" 
                               placeholder="{% trans 'Enter patient name, ID, phone, or serial number...' %}">
                        <button id="search-btn" class="btn btn-outline-primary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <small class="text-muted">
                        {% trans "You can also paste QR code data here if camera scanning doesn't work" %}
                    </small>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        {% trans "Search Results" %}
                        <span id="results-count" class="badge bg-secondary ms-2">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="search-results">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p>{% trans "Scan a QR code or search manually to see results here" %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- QR Code Scanning Library -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
let html5QrCode;
let isScanning = false;

document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-camera');
    const stopBtn = document.getElementById('stop-camera');
    const statusDiv = document.getElementById('scanner-status');
    const searchInput = document.getElementById('manual-search');
    const searchBtn = document.getElementById('search-btn');
    const resultsDiv = document.getElementById('search-results');
    const resultsCount = document.getElementById('results-count');

    // Start camera scanning
    startBtn.addEventListener('click', function() {
        startScanning();
    });

    // Stop camera scanning
    stopBtn.addEventListener('click', function() {
        stopScanning();
    });

    // Manual search
    searchBtn.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query) {
            performSearch('', query);
        }
    });

    // Search on Enter key
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBtn.click();
        }
    });

    function startScanning() {
        if (isScanning) return;

        html5QrCode = new Html5Qrcode("camera-preview");
        
        updateStatus('info', "{% trans 'Starting camera...' %}");
        
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                const cameraId = devices[0].id;
                
                html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,
                        qrbox: { width: 200, height: 200 }
                    },
                    (decodedText, decodedResult) => {
                        // QR code successfully scanned
                        updateStatus('success', "{% trans 'QR Code detected! Searching...' %}");
                        performSearch(decodedText);
                        stopScanning(); // Stop after successful scan
                    },
                    (errorMessage) => {
                        // Handle scan errors (mostly ignore)
                    }
                ).then(() => {
                    isScanning = true;
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                    updateStatus('info', "{% trans 'Scanning for QR codes...' %}");
                    document.getElementById('scanner-placeholder').style.display = 'none';
                }).catch(err => {
                    updateStatus('error', "{% trans 'Failed to start camera: ' %}" + err);
                });
            } else {
                updateStatus('error', "{% trans 'No cameras found on this device' %}");
            }
        }).catch(err => {
            updateStatus('error', "{% trans 'Error accessing cameras: ' %}" + err);
        });
    }

    function stopScanning() {
        if (html5QrCode && isScanning) {
            html5QrCode.stop().then(() => {
                isScanning = false;
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                updateStatus('info', "{% trans 'Camera stopped' %}");
                document.getElementById('scanner-placeholder').style.display = 'flex';
            }).catch(err => {
                updateStatus('error', "{% trans 'Error stopping camera: ' %}" + err);
            });
        }
    }

    function updateStatus(type, message) {
        statusDiv.className = `scanner-status ${type}`;
        statusDiv.textContent = message;
    }

    function performSearch(qrData = '', searchQuery = '') {
        const data = {
            qr_data: qrData,
            search_query: searchQuery
        };

        fetch('{% url "dashboard:qr_search" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayResults(data.results);
                updateStatus('success', `{% trans 'Found' %} ${data.count} {% trans 'result(s)' %}`);
            } else {
                updateStatus('error', data.error);
                displayResults([]);
            }
        })
        .catch(error => {
            updateStatus('error', "{% trans 'Search failed: ' %}" + error);
            displayResults([]);
        });
    }

    function displayResults(results) {
        resultsCount.textContent = results.length;
        
        if (results.length === 0) {
            resultsDiv.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-search fa-2x mb-2"></i>
                    <p>{% trans "No results found" %}</p>
                </div>
            `;
            return;
        }

        const resultsHtml = results.map(result => {
            const typeColors = {
                'patient': 'primary',
                'doctor': 'success',
                'appointment': 'info',
                'lab_order': 'warning',
                'radiology_order': 'danger',
                'bill': 'secondary'
            };
            
            const typeLabels = {
                'patient': "{% trans 'Patient' %}",
                'doctor': "{% trans 'Doctor' %}",
                'appointment': "{% trans 'Appointment' %}",
                'lab_order': "{% trans 'Lab Order' %}",
                'radiology_order': "{% trans 'Radiology' %}",
                'bill': "{% trans 'Bill' %}"
            };

            const detailsHtml = Object.entries(result.details || {})
                .filter(([key, value]) => value)
                .map(([key, value]) => `<span class="me-3"><strong>${key}:</strong> ${value}</span>`)
                .join('');

            return `
                <div class="search-result">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-${typeColors[result.type]} result-type-badge me-2">
                                    ${typeLabels[result.type]}
                                </span>
                                <h6 class="mb-0">${result.title}</h6>
                            </div>
                            
                            ${result.subtitle ? `<p class="text-muted mb-2">${result.subtitle}</p>` : ''}
                            
                            ${detailsHtml ? `<div class="result-details">${detailsHtml}</div>` : ''}
                        </div>
                        
                        <a href="${result.url}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
            `;
        }).join('');

        resultsDiv.innerHTML = resultsHtml;
    }

    // Add CSRF token to all requests
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        const meta = document.createElement('meta');
        meta.name = 'csrf-token';
        meta.content = '{{ csrf_token }}';
        document.getElementsByTagName('head')[0].appendChild(meta);
    }
});
</script>
{% endblock %}
