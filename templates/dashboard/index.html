<!-- index.html -->
{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}HMS - Dashboard{% endblock %}

{% block extra_css %}
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Dashboard-specific styles */
    .dashboard-header {
        background: linear-gradient(to right, #f8f9fa, #ffffff);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .stats-card {
        height: 100%;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
    }

    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
    }

    .resource-status {
        background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
        border-radius: 15px;
        padding: 1.5rem;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }

    .status-active { background-color: #198754; }
    .status-warning { background-color: #ffc107; }
    .status-danger { background-color: #dc3545; }

    .appointment-card {
        transition: all 0.3s ease;
    }

    .appointment-card:hover {
        transform: translateX(5px);
    }

    .department-status {
        position: relative;
        padding: 1rem;
        border-radius: 10px;
        background: #ffffff;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .department-status:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .department-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" x-data="{ 
    stats: {
        patients: { count: 256, growth: 12 },
        appointments: { count: 48, nextIn: 30 },
        emergency: { count: 5, critical: 2 },
        billing: { count: 12, total: 25400 },
        beds: { available: 45, total: 60 },
        doctors: { available: 28, total: 32 },
        pharmacy: { orders: 34, pending: 12, completed: 22 },
        surgery: { scheduled: 8, ongoing: 2, completed: 4 },
        laboratory: { pending: 15, processing: 8, completed: 25 }
    }
}">
    <!-- Page Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Dashboard</h1>
            {% if user.is_authenticated %}
                <p class="text-muted mb-0">
                    Welcome back, {{ user|get_title }} {{ user.get_full_name|default:user.username }}
                </p>
            {% endif %}
        </div>
        <div class="d-flex gap-2 mt-2 mt-sm-0">
            <button class="btn btn-primary" 
                    hx-get="{% url 'patients:quick_add' %}" 
                    hx-target="#modal-content" 
                    data-bs-toggle="modal" 
                    data-bs-target="#quickActionModal">
                <i class="bi bi-plus-circle me-1"></i>Add Patient
            </button>
            <button class="btn btn-success" 
                    hx-get="{% url 'appointments:quick_schedule' %}" 
                    hx-target="#modal-content" 
                    data-bs-toggle="modal" 
                    data-bs-target="#quickActionModal">
                <i class="bi bi-calendar-plus me-1"></i>Schedule Appointment
            </button>
        </div>
    </div>

    <!-- Statistics Cards Row -->
    <div class="row g-4 mb-4">
        <!-- Patients Card -->
        <div class="col-xl-3 col-md-6">
            <div class="card h-100 border-start border-4 border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Total Patients</div>
                            <div class="h3 mb-0" x-text="stats.patients.count"></div>
                            <div class="text-success small mt-1">
                                <i class="bi bi-arrow-up"></i>
                                <span x-text="stats.patients.growth"></span>% increase
                            </div>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-people fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light py-2">
                    <a href="{% url 'patients:patient_list' %}" class="text-decoration-none small">
                        View Details <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Appointments Card -->
        <div class="col-xl-3 col-md-6">
            <div class="card h-100 border-start border-4 border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Today's Appointments</div>
                            <div class="h3 mb-0" x-text="stats.appointments.count"></div>
                            <div class="text-success small mt-1">
                                <i class="bi bi-clock"></i>
                                Next in <span x-text="stats.appointments.nextIn"></span> mins
                            </div>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-calendar-check fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light py-2">
                    <a href="{% url 'appointments:appointment_list' %}" class="text-decoration-none small">
                        View Schedule <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Emergency Card -->
        <div class="col-xl-3 col-md-6">
            <div class="card h-100 border-start border-4 border-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Emergency Cases</div>
                            <div class="h3 mb-0" x-text="stats.emergency.count"></div>
                            <div class="text-danger small mt-1">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span x-text="stats.emergency.critical"></span> Critical
                            </div>
                        </div>
                        <div class="text-danger">
                            <i class="bi bi-heart-pulse fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light py-2">
                    <a href="{% url 'emergency:emergency_list' %}" class="text-decoration-none small">
                        View Emergency Cases <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Billing Card -->
        <div class="col-xl-3 col-md-6">
            <div class="card h-100 border-start border-4 border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-muted small mb-1">Pending Bills</div>
                            <div class="h3 mb-0" x-text="stats.billing.count"></div>
                            <div class="text-warning small mt-1">
                                <i class="bi bi-currency-dollar"></i>
                                $<span x-text="stats.billing.total.toLocaleString()"></span> Total
                            </div>
                        </div>
                        <div class="text-warning">
                            <i class="bi bi-receipt fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light py-2">
                    <a href="#" class="text-decoration-none small">
                        View Invoices <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row g-4">
        <!-- Left Column -->
        <div class="col-xl-8">
            <!-- Upcoming Appointments -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0">Upcoming Appointments</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" 
                                hx-get="{% url 'appointments:upcoming' %}"
                                hx-target="#upcomingAppointments"
                                hx-trigger="click, every 5m">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <a href="{% url 'appointments:appointment_create' %}" class="btn btn-sm btn-primary">
                            <i class="bi bi-plus-lg"></i> New Appointment
                        </a>
                    </div>
                </div>
                <div id="upcomingAppointments">
                    <!-- Content will be loaded here -->
                    {% include 'appointments/upcoming_list.html' with appointments=upcoming_appointments %}
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Activity</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                type="button" 
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                            Today
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><button class="dropdown-item">Today</button></li>
                            <li><button class="dropdown-item">This Week</button></li>
                            <li><button class="dropdown-item">This Month</button></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="activity-list" hx-trigger="load">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <div>
                                        <i class="bi bi-person-plus text-success"></i>
                                        <span>New patient registered</span>
                                        <small class="text-muted d-block">John Doe - Male, 45 years</small>
                                    </div>
                                    <small class="text-muted">3 mins ago</small>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <div>
                                        <i class="bi bi-calendar-check text-primary"></i>
                                        <span>Appointment completed</span>
                                        <small class="text-muted d-block">Dr. Sarah with Patient ID #12458</small>
                                    </div>
                                    <small class="text-muted">1 hour ago</small>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <div>
                                        <i class="bi bi-currency-dollar text-warning"></i>
                                        <span>Payment received</span>
                                        <small class="text-muted d-block">Invoice #INV-001234 - $450.00</small>
                                    </div>
                                    <small class="text-muted">2 hours ago</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-xl-4">
            <!-- Today's Overview Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Today's Overview</h5>
                    <span class="text-muted small" x-text="new Date().toLocaleDateString()"></span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-clipboard-pulse text-primary me-2"></i>
                                Active Cases
                            </div>
                            <span class="badge bg-primary rounded-pill" x-text="stats.patients.count - stats.emergency.count"></span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-heart-pulse-fill text-danger me-2"></i>
                                Emergency Cases
                            </div>
                            <span class="badge bg-danger rounded-pill" x-text="stats.emergency.count"></span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-calendar2-check text-success me-2"></i>
                                Completed Appointments
                            </div>
                            <span class="badge bg-success rounded-pill">18</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resource Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Resource Status</h5>
                </div>
                <div class="card-body">
                    <!-- Bed Availability -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <i class="bi bi-hospital text-primary me-2"></i>
                                <label class="text-muted small">Available Beds</label>
                            </div>
                            <small class="text-muted" x-text="`${stats.beds.available}/${stats.beds.total}`"></small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" 
                                 role="progressbar" 
                                 x-bind:style="`width: ${(stats.beds.available/stats.beds.total)*100}%`" 
                                 x-bind:aria-valuenow="stats.beds.available"
                                 aria-valuemin="0" 
                                 x-bind:aria-valuemax="stats.beds.total">
                            </div>
                        </div>
                    </div>

                    <!-- Doctor Availability -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <i class="bi bi-person-vcard text-info me-2"></i>
                                <label class="text-muted small">Doctors On Duty</label>
                            </div>
                            <small class="text-muted" x-text="`${stats.doctors.available}/${stats.doctors.total}`"></small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" 
                                 role="progressbar" 
                                 x-bind:style="`width: ${(stats.doctors.available/stats.doctors.total)*100}%`"
                                 x-bind:aria-valuenow="stats.doctors.available"
                                 aria-valuemin="0" 
                                 x-bind:aria-valuemax="stats.doctors.total">
                            </div>
                        </div>
                    </div>

                    <!-- Operating Rooms -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <i class="bi bi-scissors text-warning me-2"></i>
                                <label class="text-muted small">Operating Rooms</label>
                            </div>
                            <small class="text-muted">
                                <span class="text-warning" x-text="stats.surgery.ongoing"></span> in use
                            </small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" 
                                 role="progressbar" 
                                 x-bind:style="`width: ${(stats.surgery.ongoing/5)*100}%`"
                                 aria-valuemin="0" 
                                 aria-valuemax="5">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Department Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Department Status</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <!-- Pharmacy Status -->
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div>
                                    <i class="bi bi-capsule text-success me-2"></i>
                                    Pharmacy
                                </div>
                                <small class="text-muted" x-text="`${stats.pharmacy.orders} Orders Today`"></small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     x-bind:style="`width: ${(stats.pharmacy.completed/stats.pharmacy.orders)*100}%`">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted" x-text="`${stats.pharmacy.pending} Pending`"></small>
                                <small class="text-muted" x-text="`${stats.pharmacy.completed} Completed`"></small>
                            </div>
                        </div>

                        <!-- Laboratory Status -->
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div>
                                    <i class="bi bi-flask text-info me-2"></i>
                                    Laboratory
                                </div>
                                <small class="text-muted" x-text="`${stats.laboratory.pending + stats.laboratory.processing + stats.laboratory.completed} Tests Today`"></small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-info" 
                                     role="progressbar" 
                                     x-bind:style="`width: ${(stats.laboratory.completed/(stats.laboratory.pending + stats.laboratory.processing + stats.laboratory.completed))*100}%`">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted" x-text="`${stats.laboratory.pending} Pending`"></small>
                                <small class="text-muted" x-text="`${stats.laboratory.processing} Processing`"></small>
                                <small class="text-muted" x-text="`${stats.laboratory.completed} Completed`"></small>
                            </div>
                        </div>

                        <!-- Surgery Department -->
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div>
                                    <i class="bi bi-hospital text-danger me-2"></i>
                                    Surgery Department
                                </div>
                                <small class="text-muted" x-text="`${stats.surgery.scheduled} Scheduled`"></small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-danger" 
                                     role="progressbar" 
                                     x-bind:style="`width: ${(stats.surgery.completed/stats.surgery.scheduled)*100}%`">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted" x-text="`${stats.surgery.ongoing} Ongoing`"></small>
                                <small class="text-muted" x-text="`${stats.surgery.completed} Completed`"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Action Modal -->
<div class="modal fade" id="quickActionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content will be loaded here via HTMX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Enhanced Animation for Stats Cards
        const statsCards = document.querySelectorAll('.stats-card');
        statsCards.forEach((card, index) => {
            card.style.animation = `fadeInUp ${0.3 + index * 0.1}s ease forwards`;
        });

        // Enhanced Tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                boundary: document.body
            });
        });

        // Enhanced Progress Bar Animations
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            const value = bar.getAttribute('aria-valuenow');
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = value + '%';
            }, 100);
        });

        // Enhanced Notifications
        const showNotification = (message, type = 'info') => {
            toastr[type](message, '', {
                progressBar: true,
                closeButton: true,
                timeOut: 5000,
                extendedTimeOut: 2000,
                preventDuplicates: true,
                newestOnTop: true
            });
        };

        // Initialize Select2
        if ($.fn.select2) {
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });
        }

        // Toast notifications
        {% if messages %}
            {% for message in messages %}
                toastr.{{ message.tags }}('{{ message }}');
            {% endfor %}
        {% endif %}

        // Periodic Data Updates
        const updateDashboardData = () => {
            htmx.trigger('#appointments-list', 'load');
            htmx.trigger('#activity-list', 'load');
        };

        setInterval(updateDashboardData, 300000); // Update every 5 minutes

        // HTMX CSRF Token Setup
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
    });
</script>
{% endblock %}