{% load i18n %}
{% load humanize %}

<!-- Notifications Partial Template -->
<div class="notifications-container"
     x-data="{
         notifications: [],
         unreadCount: 0,
         loading: false,
         error: null,
         showAll: false,

         init() {
             this.loadNotifications();
             this.startRealTimeUpdates();
         },

         loadNotifications() {
             this.loading = true;
             fetch('{% url "dashboard:api_notifications" %}')
                 .then(response => response.json())
                 .then(data => {
                     this.notifications = data.notifications || [];
                     this.unreadCount = data.unread_count || 0;
                     this.loading = false;
                 })
                 .catch(error => {
                     this.error = 'Failed to load notifications';
                     this.loading = false;
                 });
         },

         markAsRead(notificationId) {
             fetch(`{% url "notifications:mark_read" 0 %}`.replace('0', notificationId), {
                 method: 'POST',
                 headers: {
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                     'Content-Type': 'application/json'
                 }
             })
             .then(() => {
                 const notification = this.notifications.find(n => n.id === notificationId);
                 if (notification && !notification.read) {
                     notification.read = true;
                     this.unreadCount = Math.max(0, this.unreadCount - 1);
                 }
             })
             .catch(error => console.error('Failed to mark notification as read'));
         },

         markAllAsRead() {
             if (this.unreadCount === 0) return;

             fetch('{% url "notifications:mark_all_read" %}', {
                 method: 'POST',
                 headers: {
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                     'Content-Type': 'application/json'
                 }
             })
             .then(() => {
                 this.notifications.forEach(n => n.read = true);
                 this.unreadCount = 0;
             })
             .catch(error => console.error('Failed to mark all notifications as read'));
         },

         deleteNotification(notificationId) {
             if (!confirm('{% trans "Are you sure you want to delete this notification?" %}')) return;

             fetch(`{% url "notifications:delete" 0 %}`.replace('0', notificationId), {
                 method: 'DELETE',
                 headers: {
                     'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                 }
             })
             .then(() => {
                 const index = this.notifications.findIndex(n => n.id === notificationId);
                 if (index > -1) {
                     const notification = this.notifications[index];
                     if (!notification.read) {
                         this.unreadCount = Math.max(0, this.unreadCount - 1);
                     }
                     this.notifications.splice(index, 1);
                 }
             })
             .catch(error => console.error('Failed to delete notification'));
         },

         startRealTimeUpdates() {
             // Simulate real-time updates with periodic refresh
             setInterval(() => {
                 if (!this.loading) {
                     this.loadNotifications();
                 }
             }, 60000); // Check every minute
         },

         getNotificationIcon(type) {
             const icons = {
                 'appointment': 'bi-calendar-event',
                 'patient': 'bi-person-plus',
                 'lab_result': 'bi-clipboard-data',
                 'billing': 'bi-receipt',
                 'system': 'bi-gear',
                 'emergency': 'bi-exclamation-triangle',
                 'message': 'bi-envelope'
             };
             return icons[type] || 'bi-bell';
         },

         getNotificationColor(type, priority) {
             if (priority === 'high') return 'danger';
             if (priority === 'medium') return 'warning';

             const colors = {
                 'appointment': 'primary',
                 'patient': 'success',
                 'lab_result': 'info',
                 'billing': 'warning',
                 'system': 'secondary',
                 'emergency': 'danger',
                 'message': 'primary'
             };
             return colors[type] || 'secondary';
         }
     }"
     x-init="init()">

    <!-- Notifications Card -->
    <div class="card">
        <div class="card-header bg-transparent border-0">
            <div class="d-flex align-items-center justify-content-between">
                <h6 class="card-title mb-0 d-flex align-items-center">
                    <i class="bi bi-bell me-2"></i>
                    {% trans "Notifications" %}
                    <span x-show="unreadCount > 0"
                          class="badge bg-danger ms-2 rounded-pill"
                          x-text="unreadCount"></span>
                </h6>

                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            :disabled="loading">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button class="dropdown-item"
                                    @click="markAllAsRead()"
                                    :disabled="unreadCount === 0">
                                <i class="bi bi-check2-all me-2"></i>
                                {% trans "Mark all as read" %}
                            </button>
                        </li>
                        <li>
                            <button class="dropdown-item" @click="loadNotifications()">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                {% trans "Refresh" %}
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="{% url 'notifications:settings' %}">
                                <i class="bi bi-gear me-2"></i>
                                {% trans "Notification Settings" %}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <!-- Loading State -->
            <div x-show="loading" class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">{% trans "Loading..." %}</span>
                </div>
                <p class="mt-2 mb-0 text-muted small">{% trans "Loading notifications..." %}</p>
            </div>

            <!-- Error State -->
            <div x-show="error"
                 class="alert alert-warning mx-3 mt-3"
                 role="alert"
                 x-transition>
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span x-text="error"></span>
                <button type="button"
                        class="btn-close ms-auto"
                        @click="error = null; loadNotifications()"
                        aria-label="{% trans 'Close' %}"></button>
            </div>

            <!-- Notifications List -->
            <div x-show="!loading && !error" class="notifications-list">
                <template x-for="(notification, index) in (showAll ? notifications : notifications.slice(0, 5))" :key="notification.id">
                    <div class="notification-item border-bottom"
                         :class="{ 'notification-unread': !notification.read }"
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0 transform translate-x-4"
                         x-transition:enter-end="opacity-100 transform translate-x-0">

                        <div class="d-flex align-items-start p-3">
                            <!-- Notification Icon -->
                            <div class="notification-icon me-3 flex-shrink-0">
                                <div class="rounded-circle d-flex align-items-center justify-content-center"
                                     :class="`bg-${getNotificationColor(notification.type, notification.priority)} bg-opacity-10`"
                                     style="width: 40px; height: 40px;">
                                    <i :class="`${getNotificationIcon(notification.type)} text-${getNotificationColor(notification.type, notification.priority)}`"></i>
                                </div>
                            </div>

                            <!-- Notification Content -->
                            <div class="notification-content flex-grow-1">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="notification-text">
                                        <p class="mb-1 fw-medium" x-text="notification.title"></p>
                                        <p class="mb-1 text-muted small" x-text="notification.message"></p>

                                        <!-- Notification Metadata -->
                                        <div class="d-flex align-items-center gap-3 mt-2">
                                            <small class="text-muted d-flex align-items-center">
                                                <i class="bi bi-clock me-1"></i>
                                                <span x-text="notification.created_at"></span>
                                            </small>

                                            <template x-if="notification.priority">
                                                <span class="badge badge-sm"
                                                      :class="{
                                                          'bg-danger': notification.priority === 'high',
                                                          'bg-warning': notification.priority === 'medium',
                                                          'bg-info': notification.priority === 'low'
                                                      }"
                                                      x-text="notification.priority.charAt(0).toUpperCase() + notification.priority.slice(1)">
                                                </span>
                                            </template>

                                            <template x-if="!notification.read">
                                                <span class="badge bg-primary badge-sm">{% trans "New" %}</span>
                                            </template>
                                        </div>
                                    </div>

                                    <!-- Notification Actions -->
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-ghost dropdown-toggle"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <template x-if="!notification.read">
                                                    <button class="dropdown-item"
                                                            @click="markAsRead(notification.id)">
                                                        <i class="bi bi-check me-2"></i>
                                                        {% trans "Mark as read" %}
                                                    </button>
                                                </template>
                                            </li>
                                            <li>
                                                <template x-if="notification.action_url">
                                                    <a class="dropdown-item"
                                                       :href="notification.action_url"
                                                       @click="markAsRead(notification.id)">
                                                        <i class="bi bi-eye me-2"></i>
                                                        {% trans "View Details" %}
                                                    </a>
                                                </template>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-danger"
                                                        @click="deleteNotification(notification.id)">
                                                    <i class="bi bi-trash me-2"></i>
                                                    {% trans "Delete" %}
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <template x-if="notification.action_url && !notification.read">
                                    <div class="mt-2">
                                        <a :href="notification.action_url"
                                           class="btn btn-sm btn-outline-primary"
                                           @click="markAsRead(notification.id)">
                                            <span x-text="notification.action_text || '{% trans "View" %}'"></span>
                                        </a>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Empty State -->
                <template x-if="notifications.length === 0 && !loading">
                    <div class="empty-state text-center py-5">
                        <div class="empty-state-icon mb-3">
                            <i class="bi bi-bell-slash text-muted" style="font-size: 3rem;"></i>
                        </div>
                        <h6 class="text-muted mb-2">{% trans "No Notifications" %}</h6>
                        <p class="text-muted small">
                            {% trans "You're all caught up! New notifications will appear here." %}
                        </p>
                    </div>
                </template>

                <!-- Show More/Less Toggle -->
                <template x-if="notifications.length > 5">
                    <div class="text-center py-3 border-top bg-light">
                        <button type="button"
                                class="btn btn-sm btn-outline-primary"
                                @click="showAll = !showAll"
                                x-text="showAll ? '{% trans "Show Less" %}' : `{% trans "Show All" %} (${notifications.length - 5} {% trans "more" %})`">
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Footer -->
        <div class="card-footer bg-transparent border-0 text-center">
            <a href="{% url 'notifications:list' %}"
               class="btn btn-sm btn-outline-primary">
                <i class="bi bi-list me-1"></i>
                {% trans "View All Notifications" %}
            </a>
        </div>
    </div>
</div>

<!-- Notification Styles -->
<style>
.notification-item {
    transition: background-color 0.2s ease;
}

.notification-item:hover {
    background-color: rgba(0,0,0,0.02);
}

.notification-unread {
    background-color: rgba(13, 110, 253, 0.03);
    border-left: 4px solid var(--bs-primary);
}

.notification-unread:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

.btn-ghost {
    border: none;
    background: transparent;
    color: var(--bs-secondary);
}

.btn-ghost:hover {
    background-color: rgba(0,0,0,0.05);
    color: var(--bs-dark);
}

.notification-icon .rounded-circle {
    transition: transform 0.2s ease;
}

.notification-item:hover .notification-icon .rounded-circle {
    transform: scale(1.05);
}

.badge-sm {
    font-size: 0.65em;
    padding: 0.25em 0.5em;
}

@keyframes notification-slide-in {
    from {
        opacity: 0;
        transform: translateX(20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.notification-enter {
    animation: notification-slide-in 0.3s ease-out;
}
</style>
