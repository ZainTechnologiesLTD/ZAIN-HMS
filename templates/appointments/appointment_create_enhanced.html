{% extends 'base_dashboard.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .appointment-wizard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
    }

    .wizard-step {
        display: none;
        animation: fadeInUp 0.5s ease-out;
    }

    .wizard-step.active {
        display: block;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .step-indicator .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 10px;
        color: white;
        font-weight: bold;
        transition: all 0.3s ease;
        position: relative;
    }

    .step-indicator .step.active {
        background: white;
        color: #667eea;
        transform: scale(1.1);
    }

    .step-indicator .step.completed {
        background: #28a745;
        color: white;
    }

    .step-indicator .step:not(:last-child)::after {
        content: '';
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
    }

    .patient-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .patient-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
    }

    .patient-card.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .doctor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .doctor-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .doctor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
    }

    .doctor-card.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .doctor-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        font-weight: bold;
    }

    .time-slot-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 1rem;
    }

    .time-slot {
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #495057;
    }

    .time-slot:hover {
        border-color: #667eea;
        background: #667eea;
        color: white;
        transform: translateY(-2px);
    }

    .time-slot.selected {
        border-color: #28a745;
        background: #28a745;
        color: white;
    }

    .time-slot.unavailable {
        background: #f8d7da;
        color: #721c24;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .form-floating-custom {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .form-floating-custom input,
    .form-floating-custom textarea,
    .form-floating-custom select {
        width: 100%;
        padding: 1rem 1rem 1rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        background: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-floating-custom input:focus,
    .form-floating-custom textarea:focus,
    .form-floating-custom select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }

    .form-floating-custom label {
        position: absolute;
        top: 1rem;
        left: 1rem;
        font-size: 1rem;
        color: #6c757d;
        background: white;
        padding: 0 5px;
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .form-floating-custom input:focus + label,
    .form-floating-custom textarea:focus + label,
    .form-floating-custom select:focus + label,
    .form-floating-custom input:not(:placeholder-shown) + label,
    .form-floating-custom textarea:not(:placeholder-shown) + label,
    .form-floating-custom select:not([value=""]) + label {
        top: -8px;
        font-size: 0.75rem;
        color: #667eea;
        font-weight: 600;
    }

    .search-box {
        position: relative;
        margin-bottom: 2rem;
    }

    .search-box input {
        width: 100%;
        padding: 15px 20px 15px 50px;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
    }

    .search-box i {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 1.2rem;
    }

    .wizard-nav {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }

    .btn-wizard {
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .btn-wizard.btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-wizard.btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-wizard.btn-secondary {
        background: #6c757d;
        color: white;
    }

    .appointment-summary {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        font-weight: 600;
        color: #495057;
    }

    .summary-value {
        color: #667eea;
        font-weight: 500;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .specialty-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 2rem;
    }

    .specialty-badge {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .specialty-badge:hover,
    .specialty-badge.active {
        background: white;
        color: #667eea;
        border-color: white;
    }

    .quick-actions {
        display: flex;
        gap: 15px;
        margin-bottom: 2rem;
    }

    .quick-action-btn {
        flex: 1;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        color: white;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
    }

    .quick-action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        text-decoration: none;
        transform: translateY(-3px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Enhanced Appointment Wizard -->
    <div class="appointment-wizard">
        <div class="text-center mb-4">
            <h2 class="mb-2">üìÖ Schedule Appointment</h2>
            <p class="mb-0 opacity-75">Book an appointment in a few easy steps</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" data-step="1">1</div>
            <div class="step" data-step="2">2</div>
            <div class="step" data-step="3">3</div>
            <div class="step" data-step="4">4</div>
            <div class="step" data-step="5">5</div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <a href="{% url 'patients:create' %}" class="quick-action-btn">
                <i class="bi bi-person-plus fs-4 d-block mb-2"></i>
                <small>Add New Patient</small>
            </a>
            <a href="{% url 'appointments:appointment_list' %}" class="quick-action-btn">
                <i class="bi bi-calendar-check fs-4 d-block mb-2"></i>
                <small>View All Appointments</small>
            </a>
            <a href="{% url 'doctors:doctor_list' %}" class="quick-action-btn">
                <i class="bi bi-person-badge fs-4 d-block mb-2"></i>
                <small>Doctor Schedule</small>
            </a>
        </div>

        <form id="appointmentWizardForm" method="post" novalidate>
            {% csrf_token %}

            <!-- Step 1: Patient Selection -->
            <div class="wizard-step active" id="step1">
                <h4 class="mb-4">üë§ Select Patient</h4>
                
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" id="patientSearch" placeholder="Search by name, phone, or patient ID..." autocomplete="off">
                </div>

                <div id="patientResults" class="row g-3">
                    <!-- Patient cards will be loaded here -->
                </div>

                <div class="text-center mt-4">
                    <a href="{% url 'patients:create' %}" class="btn btn-outline-light">
                        <i class="bi bi-person-plus me-2"></i>Add New Patient
                    </a>
                </div>
            </div>

            <!-- Step 2: Specialization & Doctor Selection -->
            <div class="wizard-step" id="step2">
                <h4 class="mb-4">üë®‚Äç‚öïÔ∏è Select Doctor</h4>
                
                <div class="specialty-badges">
                    <div class="specialty-badge" data-specialty="CARDIOLOGY">‚ù§Ô∏è Cardiology</div>
                    <div class="specialty-badge" data-specialty="NEUROLOGY">üß† Neurology</div>
                    <div class="specialty-badge" data-specialty="ORTHOPEDICS">ü¶¥ Orthopedics</div>
                    <div class="specialty-badge" data-specialty="PEDIATRICS">üë∂ Pediatrics</div>
                    <div class="specialty-badge" data-specialty="DERMATOLOGY">üî¨ Dermatology</div>
                    <div class="specialty-badge" data-specialty="GENERAL">üè• General</div>
                </div>

                <div id="doctorResults" class="doctor-grid">
                    <!-- Doctor cards will be loaded here -->
                </div>
            </div>

            <!-- Step 3: Date & Time Selection -->
            <div class="wizard-step" id="step3">
                <h4 class="mb-4">üìÖ Select Date & Time</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating-custom">
                            <input type="text" id="appointmentDate" name="appointment_date" placeholder=" " required>
                            <label>Appointment Date</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating-custom">
                            <select id="appointmentType" name="appointment_type" required>
                                <option value="">Select Type</option>
                                <option value="CONSULTATION">üí¨ Consultation</option>
                                <option value="FOLLOW_UP">üîÑ Follow-up</option>
                                <option value="EMERGENCY">üö® Emergency</option>
                                <option value="ROUTINE">üìã Routine Check</option>
                            </select>
                            <label>Appointment Type</label>
                        </div>
                    </div>
                </div>

                <h5 class="mt-4 mb-3">‚è∞ Available Time Slots</h5>
                <div id="timeSlots" class="time-slot-grid">
                    <!-- Time slots will be loaded here -->
                </div>
            </div>

            <!-- Step 4: Appointment Details -->
            <div class="wizard-step" id="step4">
                <h4 class="mb-4">üìù Appointment Details</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-floating-custom">
                            <textarea id="chiefComplaint" name="chief_complaint" rows="3" placeholder=" " required></textarea>
                            <label>Chief Complaint</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating-custom">
                            <textarea id="symptoms" name="symptoms" rows="3" placeholder=" "></textarea>
                            <label>Symptoms (Optional)</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-floating-custom">
                            <select id="priority" name="priority" required>
                                <option value="NORMAL">üü¢ Normal</option>
                                <option value="HIGH">üü° High</option>
                                <option value="URGENT">üî¥ Urgent</option>
                            </select>
                            <label>Priority</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating-custom">
                            <input type="number" id="duration" name="duration_minutes" value="30" min="15" max="240" step="15" placeholder=" ">
                            <label>Duration (minutes)</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-floating-custom">
                            <input type="number" id="consultationFee" name="consultation_fee" step="0.01" min="0" placeholder=" ">
                            <label>Consultation Fee ($)</label>
                        </div>
                    </div>
                </div>

                <div class="form-floating-custom">
                    <textarea id="notes" name="notes" rows="3" placeholder=" "></textarea>
                    <label>Additional Notes (Optional)</label>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="isFollowUp" name="is_follow_up">
                    <label class="form-check-label text-white" for="isFollowUp">
                        This is a follow-up appointment
                    </label>
                </div>
            </div>

            <!-- Step 5: Review & Confirm -->
            <div class="wizard-step" id="step5">
                <h4 class="mb-4">‚úÖ Review & Confirm</h4>
                
                <div class="appointment-summary">
                    <div class="summary-item">
                        <span class="summary-label">üë§ Patient:</span>
                        <span class="summary-value" id="summaryPatient">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">üë®‚Äç‚öïÔ∏è Doctor:</span>
                        <span class="summary-value" id="summaryDoctor">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">üìÖ Date:</span>
                        <span class="summary-value" id="summaryDate">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">‚è∞ Time:</span>
                        <span class="summary-value" id="summaryTime">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">üè• Type:</span>
                        <span class="summary-value" id="summaryType">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">üìù Complaint:</span>
                        <span class="summary-value" id="summaryComplaint">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">‚ö° Priority:</span>
                        <span class="summary-value" id="summaryPriority">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">üí∞ Fee:</span>
                        <span class="summary-value" id="summaryFee">-</span>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <i class="bi bi-info-circle me-2"></i>
                    Please review all details carefully before confirming the appointment.
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-nav">
                <button type="button" id="prevBtn" class="btn btn-wizard btn-secondary" style="display: none;">
                    <i class="bi bi-arrow-left me-2"></i>Previous
                </button>
                <button type="button" id="nextBtn" class="btn btn-wizard btn-primary">
                    Next<i class="bi bi-arrow-right ms-2"></i>
                </button>
                <button type="submit" id="submitBtn" class="btn btn-wizard btn-primary" style="display: none;">
                    <i class="bi bi-check-circle me-2"></i>Confirm Appointment
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<!-- Hidden form fields -->
<input type="hidden" id="selectedPatientId" name="patient">
<input type="hidden" id="selectedDoctorId" name="doctor">
<input type="hidden" id="selectedDateTime" name="date_time">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 5;
    let selectedData = {
        patient: null,
        doctor: null,
        date: null,
        time: null,
        type: null
    };

    // Initialize date picker
    const datePicker = flatpickr("#appointmentDate", {
        minDate: "today",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            selectedData.date = dateStr;
            loadTimeSlots();
        }
    });

    // Patient search functionality
    let searchTimeout;
    document.getElementById('patientSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchPatients(e.target.value);
        }, 300);
    });

    // Specialty badge selection
    document.querySelectorAll('.specialty-badge').forEach(badge => {
        badge.addEventListener('click', function() {
            document.querySelectorAll('.specialty-badge').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadDoctorsBySpecialty(this.dataset.specialty);
        });
    });

    // Navigation buttons
    document.getElementById('nextBtn').addEventListener('click', nextStep);
    document.getElementById('prevBtn').addEventListener('click', prevStep);
    document.getElementById('submitBtn').addEventListener('click', submitForm);

    // Form validation before proceeding
    function validateStep(step) {
        switch(step) {
            case 1:
                return selectedData.patient !== null;
            case 2:
                return selectedData.doctor !== null;
            case 3:
                return selectedData.date !== null && selectedData.time !== null;
            case 4:
                const complaint = document.getElementById('chiefComplaint').value.trim();
                return complaint.length > 0;
            default:
                return true;
        }
    }

    function nextStep() {
        if (!validateStep(currentStep)) {
            showAlert('Please complete all required fields before proceeding.', 'warning');
            return;
        }

        if (currentStep < totalSteps) {
            currentStep++;
            updateWizard();
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateWizard();
        }
    }

    function updateWizard() {
        // Hide all steps
        document.querySelectorAll('.wizard-step').forEach(step => {
            step.classList.remove('active');
        });

        // Show current step
        document.getElementById(`step${currentStep}`).classList.add('active');

        // Update step indicators
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum < currentStep) {
                step.classList.add('completed');
            } else if (stepNum === currentStep) {
                step.classList.add('active');
            }
        });

        // Update navigation buttons
        document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
        document.getElementById('nextBtn').style.display = currentStep < totalSteps ? 'block' : 'none';
        document.getElementById('submitBtn').style.display = currentStep === totalSteps ? 'block' : 'none';

        // Update summary on last step
        if (currentStep === totalSteps) {
            updateSummary();
        }
    }

    function searchPatients(query) {
        if (query.length < 2) {
            document.getElementById('patientResults').innerHTML = '';
            return;
        }

        showLoading(true);
        
        fetch(`{% url 'appointments:search_patients' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayPatients(data.results);
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                showLoading(false);
            });
    }

    function displayPatients(patients) {
        const container = document.getElementById('patientResults');
        
        if (patients.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center">
                    <div class="patient-card">
                        <i class="bi bi-person-x fs-1 text-muted mb-3"></i>
                        <h5 class="text-muted">No patients found</h5>
                        <p class="text-muted mb-0">Try a different search term or add a new patient</p>
                    </div>
                </div>
            `;
            return;
        }

        container.innerHTML = patients.map(patient => `
            <div class="col-md-6 col-lg-4">
                <div class="patient-card" onclick="selectPatient(${patient.id}, '${patient.text}', '${patient.phone}')">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                <i class="bi bi-person text-white fs-4"></i>
                            </div>
                        </div>
                        <div>
                            <h6 class="mb-1">${patient.text}</h6>
                            <small class="text-muted">${patient.phone}</small>
                        </div>
                    </div>
                    <div class="text-end mt-2">
                        <small class="text-primary">Click to select</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function selectPatient(id, name, phone) {
        selectedData.patient = { id, name, phone };
        document.getElementById('selectedPatientId').value = id;
        
        // Update UI
        document.querySelectorAll('.patient-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        showAlert(`Selected patient: ${name}`, 'success');
    }

    function loadDoctorsBySpecialty(specialty) {
        showLoading(true);
        
        fetch(`{% url 'appointments:get_doctors' %}?specialty=${specialty}`)
            .then(response => response.json())
            .then(data => {
                displayDoctors(data.results);
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                showLoading(false);
            });
    }

    function displayDoctors(doctors) {
        const container = document.getElementById('doctorResults');
        
        if (doctors.length === 0) {
            container.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-person-badge fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No doctors available</h5>
                    <p class="text-muted mb-0">Please select a different specialty</p>
                </div>
            `;
            return;
        }

        container.innerHTML = doctors.map(doctor => `
            <div class="doctor-card" onclick="selectDoctor('${doctor.id}', '${doctor.name}', '${doctor.specialty}')">
                <div class="doctor-avatar">
                    ${doctor.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                </div>
                <h6 class="mb-1">${doctor.name}</h6>
                <small class="text-muted">${doctor.specialty}</small>
                <div class="mt-3">
                    <small class="text-primary">Click to select</small>
                </div>
            </div>
        `).join('');
    }

    function selectDoctor(id, name, specialty) {
        selectedData.doctor = { id, name, specialty };
        document.getElementById('selectedDoctorId').value = id;
        
        // Update UI
        document.querySelectorAll('.doctor-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        showAlert(`Selected doctor: Dr. ${name}`, 'success');
        loadTimeSlots();
    }

    function loadTimeSlots() {
        if (!selectedData.doctor || !selectedData.date) return;

        showLoading(true);
        
        fetch(`{% url 'appointments:get_available_time_slots' %}?doctor_id=${selectedData.doctor.id}&date=${selectedData.date}`)
            .then(response => response.json())
            .then(data => {
                displayTimeSlots(data.slots);
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                showLoading(false);
            });
    }

    function displayTimeSlots(slots) {
        const container = document.getElementById('timeSlots');
        
        if (slots.length === 0) {
            container.innerHTML = `
                <div class="text-center">
                    <i class="bi bi-clock fs-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No available slots</h5>
                    <p class="text-muted mb-0">Please select a different date</p>
                </div>
            `;
            return;
        }

        container.innerHTML = slots.map(slot => `
            <div class="time-slot ${slot.available ? '' : 'unavailable'}" 
                 onclick="${slot.available ? `selectTimeSlot('${slot.time}')` : ''}"
                 ${!slot.available ? 'title="Already booked"' : ''}>
                ${slot.time}
            </div>
        `).join('');
    }

    function selectTimeSlot(time) {
        selectedData.time = time;
        document.getElementById('selectedDateTime').value = `${selectedData.date} ${time}`;
        
        // Update UI
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');

        showAlert(`Selected time: ${time}`, 'success');
    }

    function updateSummary() {
        document.getElementById('summaryPatient').textContent = selectedData.patient ? selectedData.patient.name : '-';
        document.getElementById('summaryDoctor').textContent = selectedData.doctor ? `Dr. ${selectedData.doctor.name}` : '-';
        document.getElementById('summaryDate').textContent = selectedData.date || '-';
        document.getElementById('summaryTime').textContent = selectedData.time || '-';
        document.getElementById('summaryType').textContent = document.getElementById('appointmentType').value || '-';
        document.getElementById('summaryComplaint').textContent = document.getElementById('chiefComplaint').value || '-';
        document.getElementById('summaryPriority').textContent = document.getElementById('priority').value || '-';
        document.getElementById('summaryFee').textContent = document.getElementById('consultationFee').value ? `$${document.getElementById('consultationFee').value}` : '-';
    }

    function submitForm() {
        if (!validateStep(4)) {
            showAlert('Please complete all required fields.', 'error');
            return;
        }

        showLoading(true);
        
        const formData = new FormData(document.getElementById('appointmentWizardForm'));
        
        fetch('{% url "appointments:appointment_create" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                showAlert('Appointment created successfully!', 'success');
                setTimeout(() => {
                    window.location.href = data.redirect_url || '{% url "appointments:appointment_list" %}';
                }, 2000);
            } else {
                showAlert(data.message || 'Error creating appointment', 'error');
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Error:', error);
            showAlert('Error creating appointment', 'error');
        });
    }

    function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function showAlert(message, type = 'info') {
        // You can implement your preferred alert system here
        // For now, using simple alert
        if (type === 'success') {
            console.log('‚úÖ ' + message);
        } else if (type === 'error') {
            console.log('‚ùå ' + message);
        } else if (type === 'warning') {
            console.log('‚ö†Ô∏è ' + message);
        } else {
            console.log('‚ÑπÔ∏è ' + message);
        }
    }

    // Load initial data
    searchPatients(''); // Load some initial patients
});
</script>
{% endblock %}
