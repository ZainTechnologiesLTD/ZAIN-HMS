{% extends 'base_dashboard.html' %}
{% load static %}

{% block extra_css %}
<style>
    .appointment-detail-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .appointment-detail-header::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(50px, -50px);
    }

    .appointment-number {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        opacity: 0.9;
    }

    .appointment-title {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .status-badge-large {
        padding: 8px 20px;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
        margin-right: 1rem;
    }

    .priority-badge-large {
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .info-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .info-card-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f8f9fa;
    }

    .info-card-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-right: 1rem;
    }

    .patient-icon {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .doctor-icon {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    }

    .appointment-icon {
        background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
    }

    .medical-icon {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .info-value {
        color: #6c757d;
        font-weight: 500;
        text-align: right;
    }

    .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: white;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .patient-avatar {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .doctor-avatar {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    }

    .contact-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .contact-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .contact-item:last-child {
        margin-bottom: 0;
    }

    .timeline {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .timeline-header {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f8f9fa;
    }

    .timeline-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin-right: 1rem;
    }

    .timeline-item {
        position: relative;
        padding-left: 3rem;
        padding-bottom: 2rem;
        border-left: 2px solid #e9ecef;
    }

    .timeline-item:last-child {
        border-left: none;
        padding-bottom: 0;
    }

    .timeline-bullet {
        position: absolute;
        left: -8px;
        top: 0;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #667eea;
    }

    .timeline-content {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
    }

    .timeline-time {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .timeline-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .timeline-description {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .action-panel {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 2rem;
    }

    .action-btn {
        width: 100%;
        padding: 15px;
        margin-bottom: 10px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        text-decoration: none;
    }

    .btn-primary-action {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-success-action {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .btn-warning-action {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
    }

    .btn-danger-action {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
    }

    .btn-info-action {
        background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%);
        color: white;
    }

    .medical-details {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .complaint-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .symptoms-section {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .notes-section {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 10px;
        padding: 1.5rem;
    }

    .section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-box {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        backdrop-filter: blur(10px);
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .related-appointments {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .related-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }

    .related-item:hover {
        background: #f8f9fa;
        border-color: #667eea;
    }

    .related-item:last-child {
        margin-bottom: 0;
    }

    @media (max-width: 768px) {
        .appointment-detail-header {
            padding: 1.5rem;
        }

        .appointment-title {
            font-size: 1.5rem;
        }

        .info-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .action-panel {
            position: static;
            margin-top: 2rem;
        }

        .quick-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .prescription-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .prescription-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }

    .prescription-item:last-child {
        margin-bottom: 0;
    }

    .medication-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .medication-details {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Enhanced Appointment Header -->
    <div class="appointment-detail-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="appointment-number">Appointment #{{ appointment.appointment_number }}</div>
                <h1 class="appointment-title">
                    {% if appointment.appointment_type %}
                        {{ appointment.appointment_type.name }}
                    {% else %}
                        General Consultation
                    {% endif %}
                </h1>
                <div class="mb-3">
                    <span class="status-badge-large status-{{ appointment.status|lower }}">
                        {{ appointment.get_status_display }}
                    </span>
                    <span class="priority-badge-large priority-{{ appointment.priority|lower }}">
                        {{ appointment.get_priority_display }}
                    </span>
                </div>
                <div class="quick-stats">
                    <div class="stat-box">
                        <div class="stat-number">{{ appointment.appointment_date|date:"d" }}</div>
                        <div class="stat-label">{{ appointment.appointment_date|date:"M Y" }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">{{ appointment.appointment_time|time:"H:i" }}</div>
                        <div class="stat-label">Appointment Time</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">{{ appointment.duration_minutes }}</div>
                        <div class="stat-label">Minutes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${{ appointment.consultation_fee|default:"0" }}</div>
                        <div class="stat-label">Consultation Fee</div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-end">
                <div class="d-flex flex-column gap-2">
                    <small class="opacity-75">Created by: {{ appointment.created_by.get_full_name|default:appointment.created_by.username }}</small>
                    <small class="opacity-75">Created on: {{ appointment.created_at|date:"M d, Y H:i" }}</small>
                    {% if appointment.updated_at != appointment.created_at %}
                    <small class="opacity-75">Last updated: {{ appointment.updated_at|date:"M d, Y H:i" }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Information Grid -->
            <div class="info-grid">
                <!-- Patient Information -->
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon patient-icon">
                            <i class="bi bi-person"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Patient Information</h5>
                            <small class="text-muted">Patient details and contact</small>
                        </div>
                    </div>

                    <div class="text-center mb-3">
                        <div class="patient-avatar mx-auto">
                            {{ appointment.patient.first_name.0 }}{{ appointment.patient.last_name.0 }}
                        </div>
                        <h6 class="mb-1">{{ appointment.patient.get_full_name }}</h6>
                        <small class="text-muted">Patient ID: {{ appointment.patient.patient_id }}</small>
                    </div>

                    <div class="contact-info">
                        <div class="contact-item">
                            <i class="bi bi-telephone text-primary"></i>
                            <span>{{ appointment.patient.phone|default:"Not provided" }}</span>
                        </div>
                        {% if appointment.patient.email %}
                        <div class="contact-item">
                            <i class="bi bi-envelope text-primary"></i>
                            <span>{{ appointment.patient.email }}</span>
                        </div>
                        {% endif %}
                        <div class="contact-item">
                            <i class="bi bi-calendar text-primary"></i>
                            <span>{{ appointment.patient.date_of_birth|default:"DOB not provided" }}</span>
                        </div>
                        {% if appointment.patient.address %}
                        <div class="contact-item">
                            <i class="bi bi-geo-alt text-primary"></i>
                            <span>{{ appointment.patient.address }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mt-3">
                        <a href="{% url 'patients:patient_detail' appointment.patient.id %}" class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-eye me-1"></i>View Patient Profile
                        </a>
                    </div>
                </div>

                <!-- Doctor Information -->
                <div class="info-card">
                    <div class="info-card-header">
                        <div class="info-card-icon doctor-icon">
                            <i class="bi bi-person-badge"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Doctor Information</h5>
                            <small class="text-muted">Attending physician details</small>
                        </div>
                    </div>

                    <div class="text-center mb-3">
                        <div class="doctor-avatar mx-auto">
                            {{ appointment.doctor.first_name.0 }}{{ appointment.doctor.last_name.0 }}
                        </div>
                        <h6 class="mb-1">Dr. {{ appointment.doctor.get_full_name }}</h6>
                        <small class="text-muted">{{ appointment.doctor.specialization|default:"General Practitioner" }}</small>
                    </div>

                    <div class="contact-info">
                        {% if appointment.doctor.phone %}
                        <div class="contact-item">
                            <i class="bi bi-telephone text-info"></i>
                            <span>{{ appointment.doctor.phone }}</span>
                        </div>
                        {% endif %}
                        {% if appointment.doctor.email %}
                        <div class="contact-item">
                            <i class="bi bi-envelope text-info"></i>
                            <span>{{ appointment.doctor.email }}</span>
                        </div>
                        {% endif %}
                        {% if appointment.doctor.department %}
                        <div class="contact-item">
                            <i class="bi bi-building text-info"></i>
                            <span>{{ appointment.doctor.department }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="mt-3">
                        <a href="{% url 'doctors:doctor_detail' appointment.doctor.id %}" class="btn btn-outline-info btn-sm w-100">
                            <i class="bi bi-eye me-1"></i>View Doctor Profile
                        </a>
                    </div>
                </div>
            </div>

            <!-- Medical Details -->
            <div class="medical-details">
                <div class="info-card-header">
                    <div class="info-card-icon medical-icon">
                        <i class="bi bi-file-medical"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Medical Information</h5>
                        <small class="text-muted">Patient symptoms and notes</small>
                    </div>
                </div>

                {% if appointment.chief_complaint %}
                <div class="complaint-section">
                    <div class="section-title">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        Chief Complaint
                    </div>
                    <p class="mb-0">{{ appointment.chief_complaint }}</p>
                </div>
                {% endif %}

                {% if appointment.symptoms %}
                <div class="symptoms-section">
                    <div class="section-title">
                        <i class="bi bi-activity text-info"></i>
                        Symptoms
                    </div>
                    <p class="mb-0">{{ appointment.symptoms }}</p>
                </div>
                {% endif %}

                {% if appointment.notes %}
                <div class="notes-section">
                    <div class="section-title">
                        <i class="bi bi-file-text text-danger"></i>
                        Additional Notes
                    </div>
                    <p class="mb-0">{{ appointment.notes }}</p>
                </div>
                {% endif %}

                {% if not appointment.chief_complaint and not appointment.symptoms and not appointment.notes %}
                <div class="text-center py-4">
                    <i class="bi bi-file-medical fs-1 text-muted"></i>
                    <h6 class="text-muted mt-2">No medical information provided</h6>
                    <p class="text-muted">Medical details will be added during the consultation.</p>
                </div>
                {% endif %}
            </div>

            <!-- Appointment Timeline -->
            {% if appointment.history.exists %}
            <div class="timeline">
                <div class="timeline-header">
                    <div class="timeline-icon">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Appointment Timeline</h5>
                        <small class="text-muted">History of status changes</small>
                    </div>
                </div>

                {% for history in appointment.history.all %}
                <div class="timeline-item">
                    <div class="timeline-bullet"></div>
                    <div class="timeline-content">
                        <div class="timeline-time">{{ history.changed_at|date:"M d, Y H:i" }}</div>
                        <div class="timeline-title">Status changed to {{ history.new_status }}</div>
                        <div class="timeline-description">
                            Changed by {{ history.changed_by.get_full_name|default:history.changed_by.username }}
                            {% if history.notes %}
                            <br>Note: {{ history.notes }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Related Appointments -->
            {% if appointment.patient.appointments.all|length > 1 %}
            <div class="related-appointments">
                <h5 class="mb-3">
                    <i class="bi bi-calendar-check me-2"></i>
                    Other Appointments for {{ appointment.patient.get_full_name }}
                </h5>

                {% for related in appointment.patient.appointments.all|slice:":5" %}
                    {% if related.id != appointment.id %}
                    <div class="related-item">
                        <div>
                            <strong>{{ related.appointment_date|date:"M d, Y" }}</strong>
                            <small class="text-muted d-block">{{ related.appointment_time|time:"H:i" }} - Dr. {{ related.doctor.get_full_name }}</small>
                        </div>
                        <div class="text-end">
                            <span class="status-badge status-{{ related.status|lower }}">{{ related.get_status_display }}</span>
                            <br>
                            <a href="{% url 'appointments:appointment_detail' related.id %}" class="btn btn-sm btn-outline-primary mt-1">View</a>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <!-- Action Panel -->
            <div class="action-panel">
                <h5 class="mb-3">
                    <i class="bi bi-gear me-2"></i>
                    Quick Actions
                </h5>

                {% if appointment.status == 'SCHEDULED' %}
                <button type="button" class="action-btn btn-success-action" onclick="checkInAppointment()">
                    <i class="bi bi-check-circle"></i>
                    Check In Patient
                </button>
                {% endif %}

                {% if appointment.status == 'CHECKED_IN' %}
                <button type="button" class="action-btn btn-primary-action" onclick="startConsultation()">
                    <i class="bi bi-play-circle"></i>
                    Start Consultation
                </button>
                {% endif %}

                {% if appointment.status == 'IN_PROGRESS' %}
                <button type="button" class="action-btn btn-success-action" onclick="completeAppointment()">
                    <i class="bi bi-check2-circle"></i>
                    Complete Appointment
                </button>
                {% endif %}

                {% if appointment.status in 'SCHEDULED,CONFIRMED' %}
                <a href="{% url 'appointments:appointment_edit' appointment.id %}" class="action-btn btn-warning-action">
                    <i class="bi bi-pencil"></i>
                    Edit Appointment
                </a>

                <button type="button" class="action-btn btn-info-action" onclick="rescheduleAppointment()">
                    <i class="bi bi-calendar2-week"></i>
                    Reschedule
                </button>

                <button type="button" class="action-btn btn-danger-action" onclick="cancelAppointment()">
                    <i class="bi bi-x-circle"></i>
                    Cancel Appointment
                </button>
                {% endif %}

                {% if appointment.status == 'COMPLETED' %}
                <a href="#" class="action-btn btn-info-action">
                    <i class="bi bi-file-earmark-medical"></i>
                    View Medical Records
                </a>

                <a href="#" class="action-btn btn-primary-action">
                    <i class="bi bi-receipt"></i>
                    Generate Invoice
                </a>
                {% endif %}

                <a href="{% url 'appointments:appointment_list' %}" class="action-btn btn-info-action">
                    <i class="bi bi-arrow-left"></i>
                    Back to List
                </a>

                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">Additional Options</h6>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="printAppointment()">
                        <i class="bi bi-printer me-1"></i>Print Details
                    </button>
                    
                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="sendReminder()">
                        <i class="bi bi-bell me-1"></i>Send Reminder
                    </button>
                    
                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="exportToPDF()">
                        <i class="bi bi-file-pdf me-1"></i>Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Check In Modal -->
<div class="modal fade" id="checkInModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Check In Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to check in {{ appointment.patient.get_full_name }} for this appointment?</p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    This will change the appointment status to "Checked In" and record the check-in time.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmCheckIn()">Check In</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Appointment Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cancelForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">Reason for Cancellation <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="cancellationReason" name="cancellation_reason" rows="3" required 
                                  placeholder="Please provide a reason for cancelling this appointment..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="notifyPatient" name="notify_patient" checked>
                        <label class="form-check-label" for="notifyPatient">
                            Notify patient about cancellation
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="confirmCancel()">Cancel Appointment</button>
            </div>
        </div>
    </div>
</div>

<!-- Reschedule Modal -->
<div class="modal fade" id="rescheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reschedule Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rescheduleForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newDate" class="form-label">New Date</label>
                                <input type="date" class="form-control" id="newDate" name="new_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="newTime" class="form-label">New Time</label>
                                <select class="form-control" id="newTime" name="new_time" required>
                                    <option value="">Select time</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="rescheduleReason" class="form-label">Reason for Rescheduling</label>
                        <textarea class="form-control" id="rescheduleReason" name="reschedule_reason" rows="3" 
                                  placeholder="Optional: Provide a reason for rescheduling..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="confirmReschedule()">Reschedule</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function checkInAppointment() {
    const modal = new bootstrap.Modal(document.getElementById('checkInModal'));
    modal.show();
}

function confirmCheckIn() {
    fetch(`{% url 'appointments:appointment_detail' appointment.id %}checkin/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('checkInModal')).hide();
            showAlert('Patient checked in successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.message || 'Error checking in patient', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error checking in patient', 'error');
    });
}

function startConsultation() {
    if (confirm('Start consultation for this appointment?')) {
        fetch(`{% url 'appointments:appointment_detail' appointment.id %}start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Consultation started!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Error starting consultation', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error starting consultation', 'error');
        });
    }
}

function completeAppointment() {
    if (confirm('Mark this appointment as completed?')) {
        fetch(`{% url 'appointments:appointment_detail' appointment.id %}complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Appointment completed!', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Error completing appointment', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error completing appointment', 'error');
        });
    }
}

function cancelAppointment() {
    const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
    modal.show();
}

function confirmCancel() {
    const reason = document.getElementById('cancellationReason').value.trim();
    const notifyPatient = document.getElementById('notifyPatient').checked;

    if (!reason) {
        showAlert('Please provide a reason for cancellation', 'warning');
        return;
    }

    fetch(`{% url 'appointments:appointment_detail' appointment.id %}cancel/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            cancellation_reason: reason,
            notify_patient: notifyPatient
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
            showAlert('Appointment cancelled successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.message || 'Error cancelling appointment', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error cancelling appointment', 'error');
    });
}

function rescheduleAppointment() {
    const modal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
    modal.show();
    
    // Set minimum date to today
    document.getElementById('newDate').min = new Date().toISOString().split('T')[0];
    
    // Load available time slots when date changes
    document.getElementById('newDate').addEventListener('change', function() {
        loadAvailableSlots(this.value);
    });
}

function loadAvailableSlots(date) {
    const timeSelect = document.getElementById('newTime');
    timeSelect.innerHTML = '<option value="">Loading...</option>';
    
    fetch(`{% url 'appointments:get_available_time_slots' %}?doctor_id={{ appointment.doctor.id }}&date=${date}&exclude={{ appointment.id }}`)
        .then(response => response.json())
        .then(data => {
            timeSelect.innerHTML = '<option value="">Select time</option>';
            data.slots.forEach(slot => {
                if (slot.available) {
                    const option = document.createElement('option');
                    option.value = slot.time;
                    option.textContent = slot.time;
                    timeSelect.appendChild(option);
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
            timeSelect.innerHTML = '<option value="">Error loading slots</option>';
        });
}

function confirmReschedule() {
    const newDate = document.getElementById('newDate').value;
    const newTime = document.getElementById('newTime').value;
    const reason = document.getElementById('rescheduleReason').value;

    if (!newDate || !newTime) {
        showAlert('Please select both date and time', 'warning');
        return;
    }

    fetch(`{% url 'appointments:appointment_detail' appointment.id %}reschedule/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            new_date: newDate,
            new_time: newTime,
            reschedule_reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('rescheduleModal')).hide();
            showAlert('Appointment rescheduled successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.message || 'Error rescheduling appointment', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error rescheduling appointment', 'error');
    });
}

function printAppointment() {
    window.print();
}

function sendReminder() {
    if (confirm('Send appointment reminder to patient?')) {
        fetch(`{% url 'appointments:appointment_detail' appointment.id %}reminder/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Reminder sent successfully!', 'success');
            } else {
                showAlert(data.message || 'Error sending reminder', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error sending reminder', 'error');
        });
    }
}

function exportToPDF() {
    window.open(`{% url 'appointments:appointment_detail' appointment.id %}export/pdf/`, '_blank');
}

function showAlert(message, type = 'info') {
    // Create a toast notification
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}
</script>
{% endblock %}
