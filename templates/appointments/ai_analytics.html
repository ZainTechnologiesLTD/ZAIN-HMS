{% extends 'base.html' %}
{% load static %}

{% block title %}AI Appointment Analytics{% endblock %}

{% block extra_css %}
<style>
    .analytics-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .analytics-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
    
    .metric-value {
        font-size: 3rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        font-size: 1.1rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    
    .metric-trend {
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-stable {
        color: #ffc107;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
    }
    
    .ai-insight {
        background: rgba(102, 126, 234, 0.1);
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0 5px 5px 0;
    }
    
    .accuracy-badge {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
        display: inline-block;
    }
    
    .efficiency-meter {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        position: relative;
        background: conic-gradient(#28a745 0deg, #28a745 var(--percentage), #e9ecef var(--percentage), #e9ecef 360deg);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .efficiency-meter::before {
        content: '';
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: white;
        position: absolute;
    }
    
    .efficiency-value {
        position: relative;
        z-index: 1;
        font-weight: bold;
        font-size: 1.2rem;
        color: #667eea;
    }
    
    .prediction-accuracy-chart {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-radius: 10px;
        padding: 1.5rem;
    }
    
    .optimization-impact {
        background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.1));
        border-radius: 10px;
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Analytics Header -->
    <div class="analytics-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-chart-line"></i> AI Appointment Analytics
                </h1>
                <p class="mb-0">Advanced analytics and predictive insights for appointment optimization</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex align-items-center justify-content-end">
                    <span class="me-3">Analysis Period:</span>
                    <span class="badge bg-light text-dark fs-6">{{ start_date|date:"M d" }} - {{ end_date|date:"M d, Y" }}</span>
                </div>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    {% if ai_insights_available %}
    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="analytics-card text-center">
                <div class="metric-value">{{ analytics_data.total_appointments|default:0 }}</div>
                <div class="metric-label">Total Appointments</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up"></i> 12% from last month
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="analytics-card text-center">
                <div class="metric-value">{{ analytics_data.prediction_accuracy.overall_accuracy|default:0|floatformat:1 }}%</div>
                <div class="metric-label">AI Prediction Accuracy</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up"></i> 3% improvement
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="analytics-card text-center">
                <div class="metric-value">{{ analytics_data.optimization_impact.wait_time_reduction|default:0|floatformat:1 }}%</div>
                <div class="metric-label">Wait Time Reduction</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up"></i> AI Optimized
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="analytics-card text-center">
                <div class="metric-value">{{ analytics_data.optimization_impact.no_show_reduction|default:0|floatformat:1 }}%</div>
                <div class="metric-label">No-Show Reduction</div>
                <div class="metric-trend trend-up">
                    <i class="fas fa-arrow-up"></i> AI Powered
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Content -->
    <div class="row">
        <!-- Left Column: Efficiency Trends -->
        <div class="col-md-8">
            <!-- Efficiency Trends Chart -->
            <div class="analytics-card">
                <h4 class="mb-4">
                    <i class="fas fa-chart-area"></i> Scheduling Efficiency Trends
                </h4>
                <div class="chart-container">
                    <canvas id="efficiencyChart"></canvas>
                </div>
                {% if analytics_data.efficiency_trends %}
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-3">
                            <small class="text-muted">Week 1</small>
                            <div class="fw-bold">{{ analytics_data.efficiency_trends.weekly_efficiency.0|default:0 }}%</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Week 2</small>
                            <div class="fw-bold">{{ analytics_data.efficiency_trends.weekly_efficiency.1|default:0 }}%</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Week 3</small>
                            <div class="fw-bold">{{ analytics_data.efficiency_trends.weekly_efficiency.2|default:0 }}%</div>
                        </div>
                        <div class="col-3">
                            <small class="text-muted">Week 4</small>
                            <div class="fw-bold">{{ analytics_data.efficiency_trends.weekly_efficiency.3|default:0 }}%</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Utilization Patterns -->
            <div class="analytics-card">
                <h4 class="mb-4">
                    <i class="fas fa-clock"></i> Resource Utilization Patterns
                </h4>
                {% if analytics_data.utilization_patterns %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Peak Hours</h6>
                        {% for hour in analytics_data.utilization_patterns.peak_hours %}
                        <span class="badge bg-warning text-dark me-1">{{ hour }}</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <h6>Optimal Scheduling Rate</h6>
                        <div class="progress">
                            <div class="progress-bar bg-success" 
                                 style="width: {{ analytics_data.utilization_patterns.optimal_scheduling_rate }}%">
                                {{ analytics_data.utilization_patterns.optimal_scheduling_rate }}%
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="utilizationChart"></canvas>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: AI Insights -->
        <div class="col-md-4">
            <!-- AI Prediction Accuracy -->
            <div class="analytics-card prediction-accuracy-chart">
                <h5 class="mb-3">
                    <i class="fas fa-brain"></i> AI Prediction Accuracy
                </h5>
                {% if analytics_data.prediction_accuracy %}
                <div class="text-center mb-3">
                    <div class="accuracy-badge">{{ analytics_data.prediction_accuracy.overall_accuracy|floatformat:1 }}%</div>
                </div>
                <div class="row text-center">
                    <div class="col-6">
                        <small class="text-muted">Precision</small>
                        <div class="fw-bold">{{ analytics_data.prediction_accuracy.precision|floatformat:1 }}%</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Recall</small>
                        <div class="fw-bold">{{ analytics_data.prediction_accuracy.recall|floatformat:1 }}%</div>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-12">
                        <small class="text-muted">F1 Score</small>
                        <div class="fw-bold">{{ analytics_data.prediction_accuracy.f1_score|floatformat:1 }}%</div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Optimization Impact -->
            <div class="analytics-card optimization-impact">
                <h5 class="mb-3">
                    <i class="fas fa-rocket"></i> AI Optimization Impact
                </h5>
                {% if analytics_data.optimization_impact %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Wait Time Reduction</span>
                        <strong>{{ analytics_data.optimization_impact.wait_time_reduction|floatformat:1 }}%</strong>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-success" 
                             style="width: {{ analytics_data.optimization_impact.wait_time_reduction }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>No-Show Reduction</span>
                        <strong>{{ analytics_data.optimization_impact.no_show_reduction|floatformat:1 }}%</strong>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-info" 
                             style="width: {{ analytics_data.optimization_impact.no_show_reduction }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Resource Utilization</span>
                        <strong>+{{ analytics_data.optimization_impact.resource_utilization_improvement|floatformat:1 }}%</strong>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-warning" 
                             style="width: {{ analytics_data.optimization_impact.resource_utilization_improvement }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Patient Satisfaction</span>
                        <strong>+{{ analytics_data.optimization_impact.patient_satisfaction_increase|floatformat:1 }}%</strong>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-primary" 
                             style="width: {{ analytics_data.optimization_impact.patient_satisfaction_increase }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- AI Insights -->
            <div class="analytics-card">
                <h5 class="mb-3">
                    <i class="fas fa-lightbulb"></i> Key AI Insights
                </h5>
                
                <div class="ai-insight">
                    <h6 class="mb-2">Efficiency Trending</h6>
                    <p class="mb-0 small">
                        {% if analytics_data.efficiency_trends.trend_direction == 'IMPROVING' %}
                        <i class="fas fa-arrow-up text-success"></i> 
                        Scheduling efficiency is improving by {{ analytics_data.efficiency_trends.improvement_rate|floatformat:1 }}% monthly.
                        {% else %}
                        <i class="fas fa-arrow-down text-warning"></i> 
                        Consider optimizing appointment scheduling strategies.
                        {% endif %}
                    </p>
                </div>
                
                <div class="ai-insight">
                    <h6 class="mb-2">Prediction Model</h6>
                    <p class="mb-0 small">
                        <i class="fas fa-brain text-primary"></i> 
                        AI model accuracy improved to {{ analytics_data.prediction_accuracy.overall_accuracy|floatformat:1 }}% 
                        with continuous learning.
                    </p>
                </div>
                
                <div class="ai-insight">
                    <h6 class="mb-2">Resource Optimization</h6>
                    <p class="mb-0 small">
                        <i class="fas fa-cogs text-info"></i> 
                        Peak hour optimization reduced average wait times by 
                        {{ analytics_data.optimization_impact.wait_time_reduction|floatformat:1 }}%.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export and Actions -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-download"></i> Export Analytics
                    </h5>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="exportAnalytics('pdf')">
                            <i class="fas fa-file-pdf"></i> Export PDF
                        </button>
                        <button class="btn btn-outline-success me-2" onclick="exportAnalytics('excel')">
                            <i class="fas fa-file-excel"></i> Export Excel
                        </button>
                        <button class="btn btn-primary" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if ai_insights_available and analytics_data %}
    // Efficiency Trends Chart
    const efficiencyCtx = document.getElementById('efficiencyChart');
    if (efficiencyCtx) {
        new Chart(efficiencyCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Efficiency %',
                    data: {{ analytics_data.efficiency_trends.weekly_efficiency|default:"[85, 87, 89, 91]" }},
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 80,
                        max: 100
                    }
                }
            }
        });
    }

    // Utilization Patterns Chart
    const utilizationCtx = document.getElementById('utilizationChart');
    if (utilizationCtx) {
        new Chart(utilizationCtx, {
            type: 'bar',
            data: {
                labels: ['8AM', '9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM'],
                datasets: [{
                    label: 'Appointments',
                    data: [12, 19, 15, 8, 10, 16, 18, 14, 11, 9],
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: '#667eea',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    {% endif %}
});

function exportAnalytics(format) {
    // Implement analytics export functionality
    console.log(`Exporting analytics in ${format} format`);
    // This would typically make an AJAX call to export endpoint
}

function refreshAnalytics() {
    // Refresh analytics data
    window.location.reload();
}
</script>
{% endblock %}
