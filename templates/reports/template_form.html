{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit Template{% else %}Create Template{% endif %} - ZAIN HMS{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-left: 4px solid var(--bs-primary);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 0 0.375rem 0.375rem 0;
    }
    .json-editor {
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
    }
    .column-builder {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background: #fff;
    }
    .column-item {
        display: flex;
        align-items-center;
        gap: 0.5rem;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            {% if form.instance.pk %}
                Edit Template: {{ form.instance.name }}
            {% else %}
                Create Report Template
            {% endif %}
        </h1>
        <p class="text-muted">Configure a reusable report template</p>
    </div>
    <a href="{% url 'reports:template_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>
        Back to Templates
    </a>
</div>

<form method="post" class="needs-validation" novalidate>
    {% csrf_token %}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Basic Information -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Basic Information
                </h5>
                
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            Template Name <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.name.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label for="{{ form.report_type.id_for_label }}" class="form-label">
                            Report Type <span class="text-danger">*</span>
                        </label>
                        {{ form.report_type }}
                        {% if form.report_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.report_type.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">
                        Description
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.description.errors.0 }}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Column Configuration -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-columns me-2"></i>
                    Column Configuration
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Visual Column Builder</h6>
                        <div class="column-builder">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Selected Columns</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addColumn()">
                                    <i class="fas fa-plus"></i> Add Column
                                </button>
                            </div>
                            
                            <div id="column-list">
                                <!-- Dynamic column items will be added here -->
                            </div>
                            
                            <div class="mt-3">
                                <h6>Available Fields</h6>
                                <div id="available-fields" class="d-flex flex-wrap gap-2">
                                    <!-- Available fields will be populated based on report type -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.columns.id_for_label }}" class="form-label">
                            Columns JSON <span class="text-danger">*</span>
                        </label>
                        {{ form.columns }}
                        {% if form.columns.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.columns.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            JSON array of column names to include in the report
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Default Filters -->
            <div class="form-section">
                <h5 class="mb-3">
                    <i class="fas fa-filter me-2"></i>
                    Default Filters
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Filter Builder</h6>
                        <div class="column-builder">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Active Filters</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFilter()">
                                    <i class="fas fa-plus"></i> Add Filter
                                </button>
                            </div>
                            
                            <div id="filter-list">
                                <!-- Dynamic filter items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="{{ form.default_filters.id_for_label }}" class="form-label">
                            Default Filters JSON
                        </label>
                        {{ form.default_filters }}
                        {% if form.default_filters.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.default_filters.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            JSON object with default filter values
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Errors -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="d-flex gap-2 mb-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>
                    {% if form.instance.pk %}Update Template{% else %}Create Template{% endif %}
                </button>
                <a href="{% url 'reports:template_list' %}" class="btn btn-outline-secondary">
                    Cancel
                </a>
                {% if form.instance.pk %}
                <button type="button" class="btn btn-outline-info" onclick="testTemplate()">
                    <i class="fas fa-play me-1"></i>
                    Test Template
                </button>
                {% endif %}
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Template Preview -->
            <div class="card sticky-top" style="top: 2rem;">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-1"></i>
                        Template Preview
                    </h6>
                </div>
                <div class="card-body">
                    <div id="template-preview">
                        <div class="text-center py-4">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Configure template to see preview</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Field Reference -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-book me-1"></i>
                        Field Reference
                    </h6>
                </div>
                <div class="card-body">
                    <div id="field-reference">
                        <p class="text-muted small">Select a report type to see available fields</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Available fields for each report type
const availableFields = {
    'PATIENT': [
        'patient_id', 'full_name', 'age', 'gender', 'blood_group', 
        'phone', 'email', 'address', 'registration_date', 'status'
    ],
    'APPOINTMENT': [
        'appointment_id', 'patient_name', 'doctor_name', 'department',
        'appointment_date', 'appointment_time', 'status', 'type', 'notes'
    ],
    'BILLING': [
        'bill_id', 'patient_name', 'amount', 'paid_amount', 'pending_amount',
        'bill_date', 'due_date', 'status', 'payment_method'
    ],
    'FINANCIAL': [
        'date', 'total_revenue', 'total_bills', 'paid_amount', 
        'pending_amount', 'collection_rate', 'department_wise'
    ],
    'DOCTOR': [
        'doctor_id', 'full_name', 'specialization', 'department',
        'patients_count', 'appointments_count', 'revenue_generated'
    ],
    'EMERGENCY': [
        'case_id', 'patient_name', 'admission_time', 'discharge_time',
        'severity_level', 'status', 'attending_doctor', 'outcome'
    ]
};

let selectedColumns = [];
let selectedFilters = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load existing data if editing
    {% if form.instance.pk %}
    try {
        selectedColumns = {{ form.instance.columns|safe }};
        selectedFilters = {{ form.instance.default_filters|safe }};
        updateColumnBuilder();
        updateFilterBuilder();
    } catch (e) {
        console.error('Error loading existing data:', e);
    }
    {% endif %}
    
    // Update preview when report type changes
    document.getElementById('{{ form.report_type.id_for_label }}').addEventListener('change', function() {
        updateAvailableFields();
        updatePreview();
    });
    
    // Update preview when form changes
    document.querySelectorAll('input, textarea, select').forEach(element => {
        element.addEventListener('input', updatePreview);
        element.addEventListener('change', updatePreview);
    });
    
    // Initial setup
    updateAvailableFields();
    updatePreview();
});

function updateAvailableFields() {
    const reportType = document.getElementById('{{ form.report_type.id_for_label }}').value;
    const fieldsContainer = document.getElementById('available-fields');
    const referenceContainer = document.getElementById('field-reference');
    
    if (reportType && availableFields[reportType]) {
        // Update available fields
        fieldsContainer.innerHTML = '';
        availableFields[reportType].forEach(field => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-dark border';
            badge.textContent = field;
            badge.style.cursor = 'pointer';
            badge.onclick = () => addColumnFromField(field);
            fieldsContainer.appendChild(badge);
        });
        
        // Update field reference
        referenceContainer.innerHTML = availableFields[reportType].map(field => 
            `<span class="badge bg-outline-primary me-1 mb-1">${field}</span>`
        ).join('');
    } else {
        fieldsContainer.innerHTML = '<span class="text-muted">Select report type first</span>';
        referenceContainer.innerHTML = '<p class="text-muted small">Select a report type to see available fields</p>';
    }
}

function addColumnFromField(field) {
    if (!selectedColumns.includes(field)) {
        selectedColumns.push(field);
        updateColumnBuilder();
        updateColumnsJSON();
    }
}

function addColumn() {
    const columnName = prompt('Enter column name:');
    if (columnName && !selectedColumns.includes(columnName)) {
        selectedColumns.push(columnName);
        updateColumnBuilder();
        updateColumnsJSON();
    }
}

function removeColumn(index) {
    selectedColumns.splice(index, 1);
    updateColumnBuilder();
    updateColumnsJSON();
}

function updateColumnBuilder() {
    const columnList = document.getElementById('column-list');
    columnList.innerHTML = '';
    
    selectedColumns.forEach((column, index) => {
        const columnItem = document.createElement('div');
        columnItem.className = 'column-item';
        columnItem.innerHTML = `
            <span class="drag-handle">
                <i class="fas fa-grip-vertical"></i>
            </span>
            <span class="flex-grow-1">${column}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeColumn(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        columnList.appendChild(columnItem);
    });
}

function updateColumnsJSON() {
    document.getElementById('{{ form.columns.id_for_label }}').value = JSON.stringify(selectedColumns);
    updatePreview();
}

function addFilter() {
    const filterKey = prompt('Enter filter key:');
    const filterValue = prompt('Enter filter value:');
    
    if (filterKey && filterValue) {
        selectedFilters[filterKey] = filterValue;
        updateFilterBuilder();
        updateFiltersJSON();
    }
}

function removeFilter(key) {
    delete selectedFilters[key];
    updateFilterBuilder();
    updateFiltersJSON();
}

function updateFilterBuilder() {
    const filterList = document.getElementById('filter-list');
    filterList.innerHTML = '';
    
    Object.entries(selectedFilters).forEach(([key, value]) => {
        const filterItem = document.createElement('div');
        filterItem.className = 'column-item';
        filterItem.innerHTML = `
            <span class="flex-grow-1">
                <strong>${key}:</strong> ${value}
            </span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFilter('${key}')">
                <i class="fas fa-times"></i>
            </button>
        `;
        filterList.appendChild(filterItem);
    });
}

function updateFiltersJSON() {
    document.getElementById('{{ form.default_filters.id_for_label }}').value = JSON.stringify(selectedFilters);
    updatePreview();
}

function updatePreview() {
    const name = document.getElementById('{{ form.name.id_for_label }}').value;
    const reportType = document.getElementById('{{ form.report_type.id_for_label }}').value;
    const description = document.getElementById('{{ form.description.id_for_label }}').value;
    
    const preview = document.getElementById('template-preview');
    
    if (name || reportType || description) {
        preview.innerHTML = `
            <div>
                <h6>${name || 'Untitled Template'}</h6>
                <p class="text-muted small">${description || 'No description'}</p>
                
                <div class="mb-3">
                    <strong>Type:</strong> ${reportType || 'Not selected'}
                </div>
                
                <div class="mb-3">
                    <strong>Columns (${selectedColumns.length}):</strong><br>
                    ${selectedColumns.length > 0 ? 
                        selectedColumns.map(col => `<span class="badge bg-primary me-1">${col}</span>`).join('') : 
                        '<span class="text-muted">No columns selected</span>'
                    }
                </div>
                
                <div>
                    <strong>Filters (${Object.keys(selectedFilters).length}):</strong><br>
                    ${Object.keys(selectedFilters).length > 0 ? 
                        Object.entries(selectedFilters).map(([k, v]) => `<span class="badge bg-secondary me-1">${k}=${v}</span>`).join('') : 
                        '<span class="text-muted">No default filters</span>'
                    }
                </div>
            </div>
        `;
    }
}

function testTemplate() {
    const form = document.querySelector('form');
    const formData = new FormData(form);
    
    // Save template first, then redirect to test
    fetch(form.action, {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            window.location.href = `{% url 'reports:use_template' form.instance.pk %}`;
        }
    });
}

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();
</script>
{% endblock %}
