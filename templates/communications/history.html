{% extends 'base/base_dashboard.html' %}
{% load static %}
{% block title %}Communication History{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1" style="background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700;">
        Communication History
      </h3>
      <p class="text-muted mb-0">All logged patient communications{% if appointment %} for appointment <code>{{ appointment.id }}</code>{% endif %}</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'communications:dashboard' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i>Dashboard</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body py-3 d-flex flex-wrap gap-3 align-items-end">
      <form method="get" class="row g-2 flex-grow-1">
        <div class="col-sm-3">
          <label class="form-label small fw-semibold mb-1">Channel</label>
          <select name="channel" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="whatsapp" {% if request.GET.channel == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
            <option value="telegram" {% if request.GET.channel == 'telegram' %}selected{% endif %}>Telegram</option>
            <option value="viber" {% if request.GET.channel == 'viber' %}selected{% endif %}>Viber</option>
            <option value="email" {% if request.GET.channel == 'email' %}selected{% endif %}>Email</option>
            <option value="sms" {% if request.GET.channel == 'sms' %}selected{% endif %}>SMS</option>
          </select>
        </div>
        <div class="col-sm-3">
          <label class="form-label small fw-semibold mb-1">Status</label>
          <select name="status" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="sent" {% if request.GET.status == 'sent' %}selected{% endif %}>Sent</option>
            <option value="delivered" {% if request.GET.status == 'delivered' %}selected{% endif %}>Delivered</option>
            <option value="read" {% if request.GET.status == 'read' %}selected{% endif %}>Read</option>
            <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
            <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
          </select>
        </div>
        <div class="col-sm-3">
          <label class="form-label small fw-semibold mb-1">From (Date)</label>
          <input type="date" name="from" value="{{ request.GET.from }}" class="form-control form-control-sm" />
        </div>
        <div class="col-sm-3">
          <label class="form-label small fw-semibold mb-1">To (Date)</label>
          <input type="date" name="to" value="{{ request.GET.to }}" class="form-control form-control-sm" />
        </div>
        <div class="col-12 d-flex gap-2 mt-2">
          <button class="btn btn-primary btn-sm"><i class="bi bi-funnel me-1"></i>Filter</button>
          <a href="?" class="btn btn-outline-secondary btn-sm">Reset</a>
        </div>
      </form>
      <div>
        <span class="badge bg-primary">Total: {{ communications|length }}</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:14rem;">Timestamp</th>
            <th>Patient</th>
            <th>Channel</th>
            <th>Status</th>
            <th>Message</th>
            <th>Appointment</th>
            <th>Sent By</th>
          </tr>
        </thead>
        <tbody>
          {% if communications %}
            {% for c in communications %}
              <tr>
                <td class="small text-nowrap">
                  {{ c.sent_at|date:'Y-m-d H:i:s' }}<br>
                  <span class="text-muted">{{ c.sent_at|timesince }} ago</span>
                </td>
                <td>
                  {% if c.patient %}
                    <strong>{{ c.patient.get_full_name }}</strong><br>
                    <small class="text-muted">{{ c.patient.patient_id }}</small>
                  {% else %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td>
                  <span class="badge bg-light text-dark border">
                    <i class="bi bi-{{ c.channel|default:'chat-dots' }} me-1"></i>{{ c.channel|title }}
                  </span>
                </td>
                <td>
                  {% if c.status == 'delivered' %}
                    <span class="badge bg-success">Delivered</span>
                  {% elif c.status == 'read' %}
                    <span class="badge bg-info text-dark">Read</span>
                  {% elif c.status == 'failed' %}
                    <span class="badge bg-danger">Failed</span>
                  {% elif c.status == 'pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% else %}
                    <span class="badge bg-secondary">Sent</span>
                  {% endif %}
                </td>
                <td style="max-width:320px;">
                  <div class="small text-truncate" title="{{ c.message }}">{{ c.message }}</div>
                </td>
                <td>
                  {% if c.appointment %}
                    <a href="{% url 'appointments:appointment_detail_enhanced' c.appointment.id %}" class="small text-decoration-none">
                      {{ c.appointment.serial_number|default:c.appointment.id|slice:":12" }}
                    </a>
                  {% else %}<span class="text-muted">—</span>{% endif %}
                </td>
                <td>
                  {% if c.sent_by %}
                    <small>{{ c.sent_by.get_username }}</small>
                  {% else %}<span class="text-muted small">System</span>{% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="mb-3"><i class="bi bi-inbox text-muted" style="font-size:3rem;opacity:.3;"></i></div>
                <h6 class="text-muted">No communications found</h6>
                <p class="text-muted small mb-0">Logs will appear here once messages are sent.</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
