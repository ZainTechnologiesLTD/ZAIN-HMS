{% extends 'base_dashboard.html' %}
{% load widget_tweaks %}

<style>
    .study-type-card {
        transition: all 0.2s ease;
        border: 2px solid #e9ecef;
    }
    
    .study-type-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .study-type-card.border-success {
        border-color: #198754 !important;
        background-color: #f8fff9;
    }
    
    .laterality-section {
        display: none;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        margin-top: 10px;
        padding-top: 10px;
    }
    
    .tab-pane {
        min-height: 300px;
    }
    
    .nav-tabs .nav-link {
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom-color: #fff;
    }
    
    /* Enhanced search dropdown styles */
    .dropdown-menu {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border-radius: 0.375rem;
        overflow: hidden;
    }
    
    .dropdown-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.15s ease-in-out;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item:hover {
        background-color: #e3f2fd;
        color: #1565c0;
    }
    
    .dropdown-item i {
        color: #6c757d;
    }
    
    .dropdown-item:hover i {
        color: #1565c0;
    }
    
    /* Selection display styles */
    #selectedPatient, #selectedDoctor {
        border: 1px solid #d1ecf1;
        background-color: #d1ecf1;
        border-radius: 0.375rem;
    }
    
    /* Search input focus styles */
    #patientSearchInput:focus, #doctorSearchInput:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Clear button styles */
    .btn-outline-secondary:hover {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    /* Position relative for dropdown containers */
    .position-relative {
        position: relative;
    }
</style>

{% block title %}Create Radiology Order - ZAIN HMS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-file-medical me-2"></i>Create Radiology Order
                    </h4>
                    <a href="{% url 'radiology:order_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Orders
                    </a>
                </div>
                
                <div class="card-body">
                    <form method="post" id="radiologyOrderForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="row">
                            <!-- Patient and Doctor Information -->
                            <div class="col-lg-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-user-md me-2"></i>Patient & Doctor Information
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.patient.id_for_label }}" class="form-label">
                                                Patient <span class="text-danger">*</span>
                                            </label>
                                            <div class="position-relative">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-user-injured"></i></span>
                                                    <input type="text" class="form-control" id="patientSearchInput" 
                                                           placeholder="Type to search patients..." autocomplete="off">
                                                    <button type="button" class="btn btn-outline-secondary" id="clearPatientBtn" style="display: none;">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div id="patientDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1050; position: absolute; top: 100%;">
                                                    <!-- Patient options will be populated here -->
                                                </div>
                                                {{ form.patient|add_class:"form-select d-none" }}
                                                <div id="selectedPatient" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                                    <small class="text-muted">Selected Patient:</small>
                                                    <div id="selectedPatientInfo" class="fw-bold"></div>
                                                </div>
                                            </div>
                                            {% if form.patient.errors %}
                                                <div class="text-danger small">{{ form.patient.errors }}</div>
                                            {% endif %}
                                            <small class="text-muted">Search and select the patient for this radiology order</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="{{ form.ordering_doctor.id_for_label }}" class="form-label">
                                                Ordering Doctor <span class="text-danger">*</span>
                                            </label>
                                            <div class="position-relative">
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="fas fa-user-md"></i></span>
                                                    <input type="text" class="form-control" id="doctorSearchInput" 
                                                           placeholder="Type to search doctors..." autocomplete="off">
                                                    <button type="button" class="btn btn-outline-secondary" id="clearDoctorBtn" style="display: none;">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div id="doctorDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1050; position: absolute; top: 100%;">
                                                    <!-- Doctor options will be populated here -->
                                                </div>
                                                {{ form.ordering_doctor|add_class:"form-select d-none" }}
                                                <div id="selectedDoctor" class="mt-2 p-2 bg-light rounded" style="display: none;">
                                                    <small class="text-muted">Selected Doctor:</small>
                                                    <div id="selectedDoctorInfo" class="fw-bold"></div>
                                                </div>
                                            </div>
                                            {% if form.ordering_doctor.errors %}
                                                <div class="text-danger small">{{ form.ordering_doctor.errors }}</div>
                                            {% endif %}
                                            <small class="text-muted">Search and select the doctor requesting the radiology studies</small>
                                        </div>

                                        <div class="mb-3">
                                            <label for="{{ form.clinical_indication.id_for_label }}" class="form-label">
                                                Clinical Indication <span class="text-danger">*</span>
                                            </label>
                                            {{ form.clinical_indication|add_class:"form-control" }}
                                            {% if form.clinical_indication.errors %}
                                                <div class="text-danger small">{{ form.clinical_indication.errors }}</div>
                                            {% endif %}
                                            <small class="text-muted">Clinical reason for the study</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Details -->
                            <div class="col-lg-6">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-clipboard-list me-2"></i>Order Details
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.priority.id_for_label }}" class="form-label">
                                                    Priority
                                                </label>
                                                {{ form.priority|add_class:"form-select" }}
                                                {% if form.priority.errors %}
                                                    <div class="text-danger small">{{ form.priority.errors }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.urgent.id_for_label }}" class="form-label">
                                                    Urgent Order
                                                </label>
                                                <div class="form-check mt-2">
                                                    {{ form.urgent|add_class:"form-check-input" }}
                                                    <label class="form-check-label" for="{{ form.urgent.id_for_label }}">
                                                        Mark as urgent
                                                    </label>
                                                </div>
                                                {% if form.urgent.errors %}
                                                    <div class="text-danger small">{{ form.urgent.errors }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="{{ form.notes.id_for_label }}" class="form-label">
                                                Additional Notes
                                            </label>
                                            {{ form.notes|add_class:"form-control" }}
                                            {% if form.notes.errors %}
                                                <div class="text-danger small">{{ form.notes.errors }}</div>
                                            {% endif %}
                                            <small class="text-muted">Any special instructions or notes</small>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Order Status</label>
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                New orders are automatically set to <strong>PENDING</strong> status
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Study Selection by Modality -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-x-ray me-2"></i>Select Radiology Studies by Modality
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if study_types %}
                                            <div class="alert alert-info">
                                                <i class="fas fa-lightbulb me-2"></i>
                                                <strong>Instructions:</strong> Choose studies from different imaging modalities below. Click on study cards to select/deselect them.
                                            </div>

                                            <!-- Modality Tabs -->
                                            <ul class="nav nav-tabs mb-4" id="modalityTabs" role="tablist">
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link active" id="xray-tab" data-bs-toggle="tab" data-bs-target="#xray-panel" type="button" role="tab">
                                                        <i class="fas fa-x-ray me-2"></i>X-Ray <span class="badge bg-secondary ms-1" id="xray-count">0</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="ct-tab" data-bs-toggle="tab" data-bs-target="#ct-panel" type="button" role="tab">
                                                        <i class="fas fa-circle-notch me-2"></i>CT Scan <span class="badge bg-secondary ms-1" id="ct-count">0</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="mri-tab" data-bs-toggle="tab" data-bs-target="#mri-panel" type="button" role="tab">
                                                        <i class="fas fa-magnet me-2"></i>MRI <span class="badge bg-secondary ms-1" id="mri-count">0</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="ultrasound-tab" data-bs-toggle="tab" data-bs-target="#ultrasound-panel" type="button" role="tab">
                                                        <i class="fas fa-wave-square me-2"></i>Ultrasound <span class="badge bg-secondary ms-1" id="ultrasound-count">0</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="mammography-tab" data-bs-toggle="tab" data-bs-target="#mammography-panel" type="button" role="tab">
                                                        <i class="fas fa-female me-2"></i>Mammography <span class="badge bg-secondary ms-1" id="mammography-count">0</span>
                                                    </button>
                                                </li>
                                                <li class="nav-item" role="presentation">
                                                    <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other-panel" type="button" role="tab">
                                                        <i class="fas fa-plus me-2"></i>Other <span class="badge bg-secondary ms-1" id="other-count">0</span>
                                                    </button>
                                                </li>
                                            </ul>

                                            <!-- Tab Content -->
                                            <div class="tab-content" id="modalityTabsContent">
                                                <!-- X-Ray Panel -->
                                                <div class="tab-pane fade show active" id="xray-panel" role="tabpanel">
                                                    <div class="row" id="xray-studies">
                                                        {% for study_type in study_types %}
                                                            {% if study_type.modality == 'X_RAY' %}
                                                                <div class="col-lg-4 col-md-6 mb-3">
                                                                    {% include 'radiology/partials/study_card.html' with study=study_type %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <div id="xray-empty" class="text-center text-muted py-4" style="display: none;">
                                                        <i class="fas fa-x-ray fa-3x mb-3"></i>
                                                        <p>No X-Ray studies available</p>
                                                    </div>
                                                </div>

                                                <!-- CT Scan Panel -->
                                                <div class="tab-pane fade" id="ct-panel" role="tabpanel">
                                                    <div class="row" id="ct-studies">
                                                        {% for study_type in study_types %}
                                                            {% if study_type.modality == 'CT' %}
                                                                <div class="col-lg-4 col-md-6 mb-3">
                                                                    {% include 'radiology/partials/study_card.html' with study=study_type %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <div id="ct-empty" class="text-center text-muted py-4" style="display: none;">
                                                        <i class="fas fa-circle-notch fa-3x mb-3"></i>
                                                        <p>No CT studies available</p>
                                                    </div>
                                                </div>

                                                <!-- MRI Panel -->
                                                <div class="tab-pane fade" id="mri-panel" role="tabpanel">
                                                    <div class="row" id="mri-studies">
                                                        {% for study_type in study_types %}
                                                            {% if study_type.modality == 'MRI' %}
                                                                <div class="col-lg-4 col-md-6 mb-3">
                                                                    {% include 'radiology/partials/study_card.html' with study=study_type %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <div id="mri-empty" class="text-center text-muted py-4" style="display: none;">
                                                        <i class="fas fa-magnet fa-3x mb-3"></i>
                                                        <p>No MRI studies available</p>
                                                    </div>
                                                </div>

                                                <!-- Ultrasound Panel -->
                                                <div class="tab-pane fade" id="ultrasound-panel" role="tabpanel">
                                                    <div class="row" id="ultrasound-studies">
                                                        {% for study_type in study_types %}
                                                            {% if study_type.modality == 'ULTRASOUND' %}
                                                                <div class="col-lg-4 col-md-6 mb-3">
                                                                    {% include 'radiology/partials/study_card.html' with study=study_type %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <div id="ultrasound-empty" class="text-center text-muted py-4" style="display: none;">
                                                        <i class="fas fa-wave-square fa-3x mb-3"></i>
                                                        <p>No Ultrasound studies available</p>
                                                    </div>
                                                </div>

                                                <!-- Mammography Panel -->
                                                <div class="tab-pane fade" id="mammography-panel" role="tabpanel">
                                                    <div class="row" id="mammography-studies">
                                                        {% for study_type in study_types %}
                                                            {% if study_type.modality == 'MAMMOGRAPHY' %}
                                                                <div class="col-lg-4 col-md-6 mb-3">
                                                                    {% include 'radiology/partials/study_card.html' with study=study_type %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <div id="mammography-empty" class="text-center text-muted py-4" style="display: none;">
                                                        <i class="fas fa-female fa-3x mb-3"></i>
                                                        <p>No Mammography studies available</p>
                                                    </div>
                                                </div>

                                                <!-- Other Panel -->
                                                <div class="tab-pane fade" id="other-panel" role="tabpanel">
                                                    <div class="row" id="other-studies">
                                                        {% for study_type in study_types %}
                                                            {% if study_type.modality not in 'X_RAY,CT,MRI,ULTRASOUND,MAMMOGRAPHY' %}
                                                                <div class="col-lg-4 col-md-6 mb-3">
                                                                    {% include 'radiology/partials/study_card.html' with study=study_type %}
                                                                </div>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <div id="other-empty" class="text-center text-muted py-4" style="display: none;">
                                                        <i class="fas fa-plus fa-3x mb-3"></i>
                                                        <p>No other imaging studies available</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Selected Studies Summary -->
                                            <div id="selectedStudiesSummary" class="mt-4" style="display: none;">
                                                <div class="card border-success">
                                                    <div class="card-header bg-light">
                                                        <h6 class="card-title mb-0 text-success">
                                                            <i class="fas fa-check-circle me-2"></i>Selected Studies
                                                        </h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="selectedStudiesList"></div>
                                                        <div class="row mt-3">
                                                            <div class="col-6">
                                                                <strong>Total Studies: <span id="totalStudies">0</span></strong>
                                                            </div>
                                                            <div class="col-6 text-end">
                                                                <strong>Total Cost: $<span id="totalCost">0.00</span></strong>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                No study types are configured for this hospital. Please contact your administrator to set up radiology study types.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{% url 'radiology:order_list' %}" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitOrderBtn" disabled>
                                        <i class="fas fa-save me-1"></i>Create Radiology Order
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden fields for selected studies -->
                        <div id="hiddenStudyFields"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const studyCheckboxes = document.querySelectorAll('.study-checkbox');
    const submitBtn = document.getElementById('submitOrderBtn');
    const selectedSummary = document.getElementById('selectedStudiesSummary');
    const selectedList = document.getElementById('selectedStudiesList');
    const totalStudiesSpan = document.getElementById('totalStudies');
    const totalCostSpan = document.getElementById('totalCost');
    const hiddenFieldsContainer = document.getElementById('hiddenStudyFields');
    
    // Enhanced search elements
    const patientSearchInput = document.getElementById('patientSearchInput');
    const doctorSearchInput = document.getElementById('doctorSearchInput');
    const patientDropdown = document.getElementById('patientDropdown');
    const doctorDropdown = document.getElementById('doctorDropdown');
    const patientSelect = document.getElementById('{{ form.patient.id_for_label }}');
    const doctorSelect = document.getElementById('{{ form.ordering_doctor.id_for_label }}');
    const clearPatientBtn = document.getElementById('clearPatientBtn');
    const clearDoctorBtn = document.getElementById('clearDoctorBtn');
    const selectedPatient = document.getElementById('selectedPatient');
    const selectedDoctor = document.getElementById('selectedDoctor');
    const selectedPatientInfo = document.getElementById('selectedPatientInfo');
    const selectedDoctorInfo = document.getElementById('selectedDoctorInfo');

    let selectedStudies = [];
    let patientOptions = [];
    let doctorOptions = [];

    // Study type data
    const studyTypes = {
        {% for study_type in study_types %}
        {{ study_type.id }}: {
            name: "{{ study_type.name|escapejs }}",
            code: "{{ study_type.code|escapejs }}",
            modality: "{{ study_type.modality|escapejs }}",
            price: {{ study_type.price|default:"0" }}
        },
        {% endfor %}
    };

    // Initialize patient and doctor options
    function initializeOptions() {
        // Get patient options
        if (patientSelect) {
            patientOptions = Array.from(patientSelect.options).map(option => ({
                value: option.value,
                text: option.text,
                element: option
            })).filter(opt => opt.value); // Remove empty option
        }

        // Get doctor options
        if (doctorSelect) {
            doctorOptions = Array.from(doctorSelect.options).map(option => ({
                value: option.value,
                text: option.text,
                element: option
            })).filter(opt => opt.value); // Remove empty option
        }
    }

    // Enhanced Patient Search
    function setupPatientSearch() {
        if (!patientSearchInput || !patientDropdown) return;

        patientSearchInput.addEventListener('focus', function() {
            showPatientDropdown();
        });

        patientSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            filterAndShowPatients(searchTerm);
        });

        patientSearchInput.addEventListener('blur', function() {
            // Delay hiding to allow for clicks
            setTimeout(() => {
                patientDropdown.style.display = 'none';
            }, 150);
        });

        clearPatientBtn.addEventListener('click', function() {
            clearPatientSelection();
        });
    }

    function filterAndShowPatients(searchTerm) {
        patientDropdown.innerHTML = '';
        
        const filteredPatients = patientOptions.filter(patient => 
            patient.text.toLowerCase().includes(searchTerm)
        );

        if (filteredPatients.length === 0) {
            patientDropdown.innerHTML = '<div class="dropdown-item-text text-muted">No patients found</div>';
        } else {
            filteredPatients.slice(0, 10).forEach(patient => { // Limit to 10 results
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.style.cursor = 'pointer';
                item.innerHTML = `<i class="fas fa-user-injured me-2"></i>${patient.text}`;
                item.addEventListener('click', function() {
                    selectPatient(patient);
                });
                patientDropdown.appendChild(item);
            });
        }
        
        patientDropdown.style.display = 'block';
    }

    function showPatientDropdown() {
        if (patientOptions.length === 0) return;
        
        patientDropdown.innerHTML = '';
        patientOptions.slice(0, 10).forEach(patient => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `<i class="fas fa-user-injured me-2"></i>${patient.text}`;
            item.addEventListener('click', function() {
                selectPatient(patient);
            });
            patientDropdown.appendChild(item);
        });
        
        patientDropdown.style.display = 'block';
    }

    function selectPatient(patient) {
        patientSearchInput.value = patient.text;
        patientSelect.value = patient.value;
        selectedPatientInfo.textContent = patient.text;
        selectedPatient.style.display = 'block';
        clearPatientBtn.style.display = 'block';
        patientDropdown.style.display = 'none';
        
        // Trigger change event
        patientSelect.dispatchEvent(new Event('change'));
    }

    function clearPatientSelection() {
        patientSearchInput.value = '';
        patientSelect.value = '';
        selectedPatient.style.display = 'none';
        clearPatientBtn.style.display = 'none';
        patientDropdown.style.display = 'none';
        patientSearchInput.focus();
    }

    // Enhanced Doctor Search
    function setupDoctorSearch() {
        if (!doctorSearchInput || !doctorDropdown) return;

        doctorSearchInput.addEventListener('focus', function() {
            showDoctorDropdown();
        });

        doctorSearchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            filterAndShowDoctors(searchTerm);
        });

        doctorSearchInput.addEventListener('blur', function() {
            // Delay hiding to allow for clicks
            setTimeout(() => {
                doctorDropdown.style.display = 'none';
            }, 150);
        });

        clearDoctorBtn.addEventListener('click', function() {
            clearDoctorSelection();
        });
    }

    function filterAndShowDoctors(searchTerm) {
        doctorDropdown.innerHTML = '';
        
        const filteredDoctors = doctorOptions.filter(doctor => 
            doctor.text.toLowerCase().includes(searchTerm)
        );

        if (filteredDoctors.length === 0) {
            doctorDropdown.innerHTML = '<div class="dropdown-item-text text-muted">No doctors found</div>';
        } else {
            filteredDoctors.slice(0, 10).forEach(doctor => { // Limit to 10 results
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.style.cursor = 'pointer';
                item.innerHTML = `<i class="fas fa-user-md me-2"></i>${doctor.text}`;
                item.addEventListener('click', function() {
                    selectDoctor(doctor);
                });
                doctorDropdown.appendChild(item);
            });
        }
        
        doctorDropdown.style.display = 'block';
    }

    function showDoctorDropdown() {
        if (doctorOptions.length === 0) return;
        
        doctorDropdown.innerHTML = '';
        doctorOptions.slice(0, 10).forEach(doctor => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `<i class="fas fa-user-md me-2"></i>${doctor.text}`;
            item.addEventListener('click', function() {
                selectDoctor(doctor);
            });
            doctorDropdown.appendChild(item);
        });
        
        doctorDropdown.style.display = 'block';
    }

    function selectDoctor(doctor) {
        doctorSearchInput.value = doctor.text;
        doctorSelect.value = doctor.value;
        selectedDoctorInfo.textContent = doctor.text;
        selectedDoctor.style.display = 'block';
        clearDoctorBtn.style.display = 'block';
        doctorDropdown.style.display = 'none';
        
        // Trigger change event
        doctorSelect.dispatchEvent(new Event('change'));
    }

    function clearDoctorSelection() {
        doctorSearchInput.value = '';
        doctorSelect.value = '';
        selectedDoctor.style.display = 'none';
        clearDoctorBtn.style.display = 'none';
        doctorDropdown.style.display = 'none';
        doctorSearchInput.focus();
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('#patientSearchInput') && !event.target.closest('#patientDropdown')) {
            patientDropdown.style.display = 'none';
        }
        if (!event.target.closest('#doctorSearchInput') && !event.target.closest('#doctorDropdown')) {
            doctorDropdown.style.display = 'none';
        }
    });

    // Update modality counts
    function updateModalityCounts() {
        const modalities = ['X_RAY', 'CT', 'MRI', 'ULTRASOUND', 'MAMMOGRAPHY'];
        const modalityNames = {
            'X_RAY': 'xray',
            'CT': 'ct', 
            'MRI': 'mri',
            'ULTRASOUND': 'ultrasound',
            'MAMMOGRAPHY': 'mammography'
        };
        
        modalities.forEach(modality => {
            const modalityName = modalityNames[modality];
            const checkedBoxes = document.querySelectorAll(
                `.study-checkbox[data-modality="${modality}"]:checked`
            );
            const count = checkedBoxes ? checkedBoxes.length : 0;
            const countElement = document.getElementById(`${modalityName}-count`);
            if (countElement) {
                countElement.textContent = count;
                countElement.className = count > 0 ? 'badge bg-success ms-1' : 'badge bg-secondary ms-1';
            }
            
            // Show/hide empty message
            const studiesContainer = document.getElementById(`${modalityName}-studies`);
            const emptyMessage = document.getElementById(`${modalityName}-empty`);
            if (studiesContainer && emptyMessage) {
                const hasStudies = studiesContainer.children.length > 0;
                emptyMessage.style.display = hasStudies ? 'none' : 'block';
            }
        });
        
        // Update "other" count
        const otherChecked = document.querySelectorAll('.study-checkbox:checked').length - 
                           modalities.reduce((sum, mod) => {
                               const boxes = document.querySelectorAll(`.study-checkbox[data-modality="${mod}"]:checked`);
                               return sum + (boxes ? boxes.length : 0);
                           }, 0);
        const otherCountElement = document.getElementById('other-count');
        if (otherCountElement) {
            otherCountElement.textContent = Math.max(0, otherChecked);
            otherCountElement.className = otherChecked > 0 ? 'badge bg-success ms-1' : 'badge bg-secondary ms-1';
        }
    }

    function updateSelectedStudies() {
        selectedStudies = [];
        let totalCost = 0;

        studyCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const studyId = parseInt(checkbox.value);
                const lateralitySelect = document.querySelector(`select[name="laterality_${studyId}"]`);
                const laterality = lateralitySelect ? lateralitySelect.value : '';
                
                selectedStudies.push({
                    id: studyId,
                    laterality: laterality,
                    ...studyTypes[studyId]
                });
                
                totalCost += studyTypes[studyId].price;
            }
        });

        // Update UI
        if (selectedStudies.length > 0) {
            selectedSummary.style.display = 'block';
            submitBtn.disabled = false;
            
            // Update summary
            selectedList.innerHTML = selectedStudies.map(study => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${study.name}</strong> (${study.code})
                        ${study.laterality ? `<br><small class="text-muted">Laterality: ${study.laterality}</small>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info">${study.modality}</span>
                        <br><small class="text-success">$${study.price}</small>
                    </div>
                </div>
            `).join('');

            totalStudiesSpan.textContent = selectedStudies.length;
            totalCostSpan.textContent = totalCost.toFixed(2);
        } else {
            selectedSummary.style.display = 'none';
            submitBtn.disabled = true;
        }

        // Update hidden form fields
        updateHiddenFields();
        
        // Update modality counts
        updateModalityCounts();
    }

    function updateHiddenFields() {
        hiddenFieldsContainer.innerHTML = '';
        
        selectedStudies.forEach((study, index) => {
            // Create hidden fields for each selected study
            const studyIdField = document.createElement('input');
            studyIdField.type = 'hidden';
            studyIdField.name = `studies[${index}][study_type]`;
            studyIdField.value = study.id;
            
            const lateralityField = document.createElement('input');
            lateralityField.type = 'hidden';
            lateralityField.name = `studies[${index}][laterality]`;
            lateralityField.value = study.laterality || '';
            
            hiddenFieldsContainer.appendChild(studyIdField);
            hiddenFieldsContainer.appendChild(lateralityField);
        });
    }

    // Event listeners for study selection
    studyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const studyCard = this.closest('.study-type-card');
            const lateralitySection = studyCard.querySelector('.laterality-section');
            
            if (this.checked) {
                studyCard.classList.add('border-success');
                lateralitySection.style.display = 'block';
            } else {
                studyCard.classList.remove('border-success');
                lateralitySection.style.display = 'none';
            }
            
            updateSelectedStudies();
        });
    });

    // Laterality change listener
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('laterality-select')) {
            updateSelectedStudies();
        }
    });

    // Form validation
    document.getElementById('radiologyOrderForm').addEventListener('submit', function(e) {
        if (selectedStudies.length === 0) {
            e.preventDefault();
            alert('Please select at least one study for this radiology order.');
            return false;
        }
    });

    // Initialize everything
    initializeOptions();
    setupPatientSearch();
    setupDoctorSearch();
    updateModalityCounts();
    updateSelectedStudies();
});
</script>

<style>
.study-type-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.study-type-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.study-type-card.border-success {
    border-color: #198754 !important;
    background-color: #f8fff9;
}

.form-check-input:checked + .form-check-label {
    color: #198754;
}

.laterality-section {
    border-top: 1px solid #e9ecef;
    padding-top: 0.5rem;
}
</style>
{% endblock %}
