name: ğŸš€ Auto Deploy Development to Main

on:
  push:
    branches: [ development ]
  workflow_dispatch: # Manual trigger from GitHub Actions tab

jobs:
  auto-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Configure Git
      run: |
        git config user.name "ZAIN HMS AutoDeploy"
        git config user.email "autodeploy@zainhms.com"
    
    - name: ğŸ“Š Check Deployment Status
      id: check
      run: |
        git checkout main
        BEHIND=$(git rev-list --count main..development)
        echo "commits_behind=$BEHIND" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Main is $BEHIND commits behind development"
        
        if [ "$BEHIND" -gt 0 ]; then
          echo "ğŸ”„ Deployment needed"
          echo "ğŸ“‹ Changes to deploy:"
          git log main..development --oneline
        else
          echo "âœ… Main is up to date"
        fi
    
    - name: ğŸš€ Deploy to Main
      if: steps.check.outputs.commits_behind != '0'
      run: |
        echo "ğŸš€ Auto-deploying development to main..."
        git merge development --no-ff -m "chore: auto-deploy development to main - $(date '+%Y-%m-%d %H:%M UTC')"
        git push origin main
        echo "âœ… Successfully auto-deployed to main!"
    
    - name: ğŸ“¦ Create Auto Release
      if: steps.check.outputs.commits_behind != '0'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: auto-v${{ github.run_number }}
        release_name: ğŸš€ Auto Release v${{ github.run_number }}
        body: |
          ## ğŸš€ Automatic Deployment from Development Branch
          
          **ğŸ“… Deployment Date:** ${{ github.event.head_commit.timestamp }}
          **ğŸ‘¤ Triggered By:** ${{ github.actor }}
          **ğŸ“ Latest Commit:** ${{ github.event.head_commit.message }}
          
          ### ğŸ“‹ Changes Included:
          This release contains all changes from the development branch that were automatically merged to main.
          
          ### ğŸ”— Links:
          - **ğŸ“Š Compare Changes:** [${{ github.event.before }}...${{ github.sha }}](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          - **ğŸ“¥ Installation:** `curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sudo bash`
          
          ### ğŸ¥ ZAIN HMS Features:
          - âœ… One-command installation
          - âœ… 3-container Docker architecture  
          - âœ… Automatic latest version detection
          - âœ… Production-ready configuration
          - âœ… Comprehensive healthcare management system
          
          ---
          *ğŸ¤– This release was automatically created by GitHub Actions*
        draft: false
        prerelease: false
    
    - name: ğŸ“¨ Deployment Notification
      if: steps.check.outputs.commits_behind != '0'
      run: |
        echo "ğŸ‰ DEPLOYMENT COMPLETE!"
        echo "ğŸ“Š Deployment Summary:"
        echo "   â€¢ Commits deployed: ${{ steps.check.outputs.commits_behind }}"
        echo "   â€¢ Release created: auto-v${{ github.run_number }}"
        echo "   â€¢ Main branch updated: âœ…"
        echo "   â€¢ Live URL: https://github.com/${{ github.repository }}"
        echo ""
        echo "ğŸ”— Installation command:"
        echo "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | sudo bash"