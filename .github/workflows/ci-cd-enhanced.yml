name: ğŸš€ ZAIN HMS CI/CD Pipeline
on:
  push:
    branches: [ main, development ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, development ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'
  DJANGO_SETTINGS_MODULE: 'zain_hms.settings'

jobs:
  # =====================================
  # TESTING & QUALITY ASSURANCE
  # =====================================
  test:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_zain_hms
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: ğŸ“¦ Cache Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
    
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install coverage pytest-django pytest-xdist
    
    - name: ğŸ” Code Quality Checks
      run: |
        # Linting with flake8
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ”’ Security Audit
      run: |
        pip install safety bandit
        safety check --json || true
        bandit -r . -x tests/ -f json || true
    
    - name: ğŸ§ª Run Django Tests
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_zain_hms
        SECRET_KEY: 'test-secret-key-for-ci'
        DEBUG: False
      run: |
        coverage run --source='.' manage.py test
        coverage report --show-missing
        coverage xml
    
    - name: ğŸ“Š Upload Coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # =====================================
  # FRONTEND TESTING
  # =====================================
  frontend-test:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ğŸ“¦ Install Frontend Dependencies
      run: |
        if [ -f "package.json" ]; then
          npm ci
        fi
    
    - name: ğŸ§ª Run JavaScript Tests
      run: |
        # Run JavaScript unit tests
        if [ -f "tests/js" ]; then
          node --test tests/js
        fi
    
    - name: ğŸ” Frontend Linting
      run: |
        # ESLint for JavaScript
        if [ -f ".eslintrc.js" ]; then
          npx eslint static/js/
        fi

  # =====================================
  # DATABASE MIGRATION TESTING
  # =====================================
  migration-test:
    name: ğŸ—„ï¸ Migration Safety Check
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: migration_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ”§ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” Validate Migrations
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/migration_test
        SECRET_KEY: 'test-migration-secret'
      run: |
        python manage.py validate_migrations --dry-run --check-backward-compatibility
        python manage.py migrate --verbosity=2

  # =====================================
  # DOCKER BUILD
  # =====================================
  build:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, frontend-test, migration-test]
    if: github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”‘ Login to Docker Registry
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ·ï¸ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/zain-hms
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha
    
    - name: ğŸš€ Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./docker/Dockerfile.prod
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ github.ref_name }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          GIT_COMMIT=${{ github.sha }}

  # =====================================
  # PRODUCTION DEPLOYMENT
  # =====================================
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    environment: 
      name: production
      url: https://zainhms.com
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
    
    - name: ğŸš€ Deploy to Server
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/zain-hms:${{ github.sha }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SECRET_KEY: ${{ secrets.HMS_SECRET }}
      run: |
        # Copy deployment script to server
        scp -o StrictHostKeyChecking=no scripts/deploy.sh $SERVER_USER@$SERVER_HOST:/tmp/
        
        # Execute deployment
        ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
          export DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"
          export DATABASE_URL="${{ env.DATABASE_URL }}"
          export SECRET_KEY="${{ env.SECRET_KEY }}"
          export VERSION="${{ github.ref_name }}"
          
          chmod +x /tmp/deploy.sh
          sudo /tmp/deploy.sh $VERSION
        EOF
    
    - name: ğŸ” Health Check
      run: |
        # Wait for deployment to complete
        sleep 60
        
        # Perform health check
        curl -f ${{ secrets.SERVER_HOST }}/health/ || exit 1
    
    - name: ğŸ“¢ Deployment Notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… ZAIN HMS v${{ github.ref_name }} deployed successfully!"
        else
          echo "âŒ ZAIN HMS deployment failed!"
        fi

  # =====================================
  # RELEASE AUTOMATION
  # =====================================
  release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [deploy]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ·ï¸ Get Version
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: ğŸ“ Generate Release Notes
      id: release_notes
      run: |
        # Generate comprehensive release notes
        cat > release_notes.md << 'EOF'
        # ZAIN HMS v${{ steps.version.outputs.VERSION }} ğŸ¥
        
        ## ğŸš€ What's New
        - Enhanced AI clinical decision support
        - Improved multi-tenant hospital management
        - Better security and performance
        - Updated dependencies and bug fixes
        
        ## ğŸ¥ Healthcare Features
        - Complete Electronic Medical Records (EMR)
        - AI-powered clinical alerts and decision support
        - Multi-tenant hospital management
        - Real-time notifications and alerts
        - Comprehensive reporting and analytics
        
        ## ğŸ”’ Security & Compliance
        - HIPAA-compliant design patterns
        - Enhanced data encryption
        - Role-based access control
        - Comprehensive audit trails
        
        ## ğŸ“± Technical Improvements
        - Zero-downtime deployment capability
        - Automatic database migration validation
        - Enhanced mobile responsiveness
        - Performance optimizations
        
        ## ğŸ› ï¸ Installation
        ```bash
        docker pull ${{ secrets.DOCKER_USERNAME }}/zain-hms:${{ steps.version.outputs.VERSION }}
        ```
        
        **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ steps.version.outputs.VERSION }}...HEAD
        EOF
    
    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        name: ZAIN HMS v${{ steps.version.outputs.VERSION }}
        tag_name: v${{ steps.version.outputs.VERSION }}
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”” Update Notification
      run: |
        # Trigger update notification system
        curl -X POST "${{ secrets.SERVER_HOST }}/api/system/check-updates/" \
          -H "Authorization: Bearer ${{ secrets.API_TOKEN }}" || true

  # =====================================
  # MONITORING & ALERTS
  # =====================================
  monitor:
    name: ğŸ“Š Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ” System Health Check
      run: |
        # Comprehensive health checks
        curl -f "${{ secrets.SERVER_HOST }}/health/" || exit 1
        curl -f "${{ secrets.SERVER_HOST }}/api/system/status/" || exit 1
    
    - name: ğŸ“ˆ Performance Check
      run: |
        # Basic performance testing
        response_time=$(curl -o /dev/null -s -w "%{time_total}" "${{ secrets.SERVER_HOST }}/")
        if (( $(echo "$response_time > 3.0" | bc -l) )); then
          echo "âš ï¸ Response time is slow: ${response_time}s"
        else
          echo "âœ… Response time is good: ${response_time}s"
        fi
    
    - name: ğŸ“Š Generate Deployment Report
      run: |
        echo "## ğŸ“‹ Deployment Report - $(date)" >> deployment_report.md
        echo "- **Version**: ${{ github.ref_name }}" >> deployment_report.md
        echo "- **Commit**: ${{ github.sha }}" >> deployment_report.md  
        echo "- **Status**: âœ… Successful" >> deployment_report.md
        echo "- **Health Check**: âœ… Passed" >> deployment_report.md
        cat deployment_report.md